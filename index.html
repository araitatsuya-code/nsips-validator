<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSIPS„Éá„Éº„Çø„Éê„É™„Éá„Éº„Çø„Éº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .input-section {
            background: #f7fafc;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }

        .input-section h2 {
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-section h2::before {
            content: "üìù";
            font-size: 1.5rem;
        }

        textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .results-section {
            background: #ffffff;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .results-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .validation-result {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid;
        }

        .result-success {
            background: #f0fff4;
            border-color: #38a169;
            color: #2f855a;
        }

        .result-warning {
            background: #fffbeb;
            border-color: #ed8936;
            color: #c05621;
        }

        .result-error {
            background: #fed7d7;
            border-color: #e53e3e;
            color: #c53030;
        }

        .record-details {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .record-header {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #cbd5e0;
        }

        .field-info {
            display: grid;
            grid-template-columns: 100px 200px 1fr;
            gap: 10px;
            margin-bottom: 8px;
            padding: 5px;
            background: white;
            border-radius: 4px;
        }

        .field-label {
            font-weight: bold;
            color: #4a5568;
        }

        .field-value {
            color: #2d3748;
            word-break: break-all;
        }

        .field-status {
            color: #718096;
            font-style: italic;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .stat-label {
            color: #718096;
            margin-top: 5px;
        }

        .version-info {
            background: #ebf8ff;
            border: 1px solid #bee3f8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .main-content {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .field-info {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>NSIPS „Éá„Éº„Çø„Éê„É™„Éá„Éº„Çø„Éº</h1>
        <p>Êñ∞Ë™øÂâ§„Ç∑„Çπ„ÉÜ„É†Ê®ôÊ∫ñIFÂÖ±Êúâ‰ªïÊßòÊõ∏ Ver. 1.06.03 Ê∫ñÊã†</p>
    </div>

    <div class="main-content">
        <div class="input-section">
            <h2>NSIPS„Éá„Éº„ÇøÂÖ•Âäõ</h2>
            <textarea id="dataInput" placeholder="NSIPS„Éá„Éº„Çø„Çí„Åì„Åì„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ...&#10;&#10;üìù „Çµ„Éù„Éº„Éà„Åô„ÇãÊîπË°åÂΩ¢Âºè:&#10;‚Ä¢ WindowsÂΩ¢Âºè (CRLF: \r\n)&#10;‚Ä¢ Unix/LinuxÂΩ¢Âºè (LF: \n)&#10;‚Ä¢ Classic MacÂΩ¢Âºè (CR: \r)&#10;‚Ä¢ „Ç®„Çπ„Ç±„Éº„Éó„Ç∑„Éº„Ç±„É≥„Çπ (\n, \r\n, \r)&#10;&#10;‰æã:&#10;VER010603,20250722153322,,PCCLIENT1,14,4,0842302,„ÉÜ„Çπ„ÉàËñ¨Â±Ä,2360042,Á•ûÂ•àÂ∑ùÁúåÊ®™ÊµúÂ∏ÇÈáëÊ≤¢Âå∫„ÉÜ„Çπ„ÉàÁî∫1-2-3,0457111111,&#10;1,,ÔæîÔæèÔæÄÔæû ÔæÄÔæõÔΩ≥,Â±±Áî∞„ÄÄÂ§™ÈÉé,1,19800101,2360045,Á•ûÂ•àÂ∑ùÁúåÊ®™ÊµúÂ∏ÇÈáëÊ≤¢Âå∫„Çµ„É≥„Éó„É´Áî∫4-5-6,,,08011112222,,2,2,144105,20230801,ÔºóÔºê,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,"></textarea>

            <div class="button-group">
                <button class="btn btn-primary" onclick="validateData()">
                    <span>üîç</span>„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÂÆüË°å
                </button>
                <button class="btn btn-secondary" onclick="loadSampleData()">
                    <span>üìÑ</span>„Çµ„É≥„Éó„É´„Éá„Éº„ÇøË™≠Ëæº
                </button>
                <button class="btn btn-secondary" onclick="loadEscapeSequenceData()">
                    <span>üî§</span>„Ç®„Çπ„Ç±„Éº„ÉóÂΩ¢Âºè„Çµ„É≥„Éó„É´
                </button>
                <button class="btn btn-secondary" onclick="clearData()">
                    <span>üóëÔ∏è</span>„ÇØ„É™„Ç¢
                </button>
            </div>
        </div>

        <div id="resultsSection" class="results-section hidden">
            <h2><span id="resultsIcon">üìä</span>„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÁµêÊûú</h2>

            <div id="versionInfo" class="version-info hidden">
                <strong>„Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±:</strong> <span id="versionText"></span>
            </div>

            <div id="statsSection" class="stats hidden">
                <div class="stat-card">
                    <span class="stat-number" id="totalRecords">0</span>
                    <div class="stat-label">Á∑è„É¨„Ç≥„Éº„ÉâÊï∞</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="validRecords">0</span>
                    <div class="stat-label">ÊúâÂäπ„É¨„Ç≥„Éº„Éâ</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="warningRecords">0</span>
                    <div class="stat-label">Ë≠¶Âëä</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="errorRecords">0</span>
                    <div class="stat-label">„Ç®„É©„Éº</div>
                </div>
            </div>

            <div id="validationResults"></div>
        </div>
    </div>
</div>

<script>
    // NSIPS‰ªïÊßòÂÆöÁæ©
    const NSIPS_SPEC = {
        version: "1.06.03",
        expectedVersion: "VER010603",

        recordTypes: {
            'HEADER': { id: 'VER', name: '„Éò„ÉÉ„ÉÄÈÉ®', required: true },
            '1': { id: '1', name: 'ÊÇ£ËÄÖÊÉÖÂ†±ÈÉ®', required: true },
            '2': { id: '2', name: 'Âá¶ÊñπÁÆãÊÉÖÂ†±ÈÉ®', required: true },
            '3': { id: '3', name: 'Áî®Ê≥ïÈÉ®', required: true },
            '4': { id: '4', name: 'Ëñ¨ÂìÅÈÉ®', required: true },
            '5': { id: '5', name: 'Ë™øÂâ§Èå≤ÈÉ®', required: false },
            '6': { id: '6', name: 'Ë™øÂâ§Èå≤ÊòéÁ¥∞ÈÉ®', required: false },
            '7': { id: '7', name: 'Âü∫Êú¨Êñô„ÉªËñ¨Â≠¶ÁÆ°ÁêÜÊñôÊÉÖÂ†±ÈÉ®', required: false },
            '8': { id: '8', name: '„ÅäËñ¨ÊâãÂ∏≥ÊÉÖÂ†±ÈÉ®', required: false }
        },

        headerFields: [
            { name: "„Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±", required: true, pattern: /^VER\d{6}$/ },
            { name: "ÈÄÅ‰ø°Êó•ÊôÇ", required: true, pattern: /^\d{14}$/ },
            { name: "ÂÇôËÄÉ", required: false },
            { name: "ÈÄÅ‰ø°Á´ØÊú´Ë≠òÂà•ÊÉÖÂ†±", required: false },
            { name: "ÈÉΩÈÅìÂ∫úÁúåÁï™Âè∑", required: true, pattern: /^\d{2}$/ },
            { name: "ÁÇπÊï∞Ë°®", required: true, pattern: /^4$/ },
            { name: "Ëñ¨Â±Ä„Ç≥„Éº„Éâ", required: true, pattern: /^\d{7}$/ },
            { name: "Ëñ¨Â±ÄÂêç", required: true },
            { name: "Ëñ¨Â±ÄÈÉµ‰æøÁï™Âè∑", required: true, pattern: /^\d{7}$/ },
            { name: "Ëñ¨Â±ÄÊâÄÂú®Âú∞", required: true },
            { name: "Ëñ¨Â±ÄÈõªË©±Áï™Âè∑", required: true, pattern: /^\d+$/ },
            { name: "Êóß„Éï„Ç°„Ç§„É´Âêç", required: false }
        ],

        patientFields: [
            { name: "Ë≠òÂà•Â≠ê", required: true, pattern: /^1$/ },
            { name: "ÊÇ£ËÄÖ„Ç≥„Éº„Éâ", required: true },
            { name: "ÊÇ£ËÄÖ„Ç´„ÉäÊ∞èÂêç", required: true },
            { name: "ÊÇ£ËÄÖÊº¢Â≠óÊ∞èÂêç", required: true },
            { name: "ÊÄßÂà•", required: true, pattern: /^[012]$/ },
            { name: "ÁîüÂπ¥ÊúàÊó•", required: true, pattern: /^\d{8}$/ }
        ]
    };

    function validateData() {
        const input = document.getElementById('dataInput').value.trim();

        if (!input) {
            showError('„Éá„Éº„Çø„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
            return;
        }

        try {
            const processedData = normalizeLineBreaks(input);
            const lines = processedData.lines.filter(line => line.trim());
            const results = performValidation(lines);
            results.lineBreakInfo = processedData.info;
            displayResults(results);
        } catch (error) {
            showError('„Éê„É™„Éá„Éº„Ç∑„Éß„É≥‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
        }
    }

    function normalizeLineBreaks(input) {
        // ÊîπË°å„Ç≥„Éº„Éâ„ÅÆÊ§úÂá∫„Å®Ê≠£Ë¶èÂåñ
        const detectionInfo = {
            originalFormat: 'unknown',
            hasEscapeSequences: false,
            detectedPatterns: [],
            processedInput: input
        };

        // „Ç®„Çπ„Ç±„Éº„Éó„Ç∑„Éº„Ç±„É≥„Çπ„ÅÆÊ§úÂá∫
        const escapePatterns = [
            { pattern: /\\r\\n/g, type: 'CRLF escape (\\r\\n)', replacement: '\r\n' },
            { pattern: /\\n/g, type: 'LF escape (\\n)', replacement: '\n' },
            { pattern: /\\r/g, type: 'CR escape (\\r)', replacement: '\r' }
        ];

        let processedInput = input;

        // „Ç®„Çπ„Ç±„Éº„Éó„Ç∑„Éº„Ç±„É≥„Çπ„ÅÆÊ§úÂá∫„Å®Â§âÊèõ
        escapePatterns.forEach(({ pattern, type, replacement }) => {
            const matches = input.match(pattern);
            if (matches) {
                detectionInfo.hasEscapeSequences = true;
                detectionInfo.detectedPatterns.push({
                    type: type,
                    count: matches.length
                });
                processedInput = processedInput.replace(pattern, replacement);
            }
        });

        // ÂÆüÈöõ„ÅÆÊîπË°å„Ç≥„Éº„Éâ„ÅÆÊ§úÂá∫
        const lineBreakPatterns = [
            { pattern: /\r\n/g, type: 'CRLF (Windows)', name: 'crlf' },
            { pattern: /\n/g, type: 'LF (Unix/Linux)', name: 'lf' },
            { pattern: /\r/g, type: 'CR (Classic Mac)', name: 'cr' }
        ];

        let detectedLineBreak = null;
        for (const { pattern, type, name } of lineBreakPatterns) {
            const matches = processedInput.match(pattern);
            if (matches && matches.length > 0) {
                if (!detectedLineBreak || matches.length > detectedLineBreak.count) {
                    detectedLineBreak = {
                        type: type,
                        name: name,
                        count: matches.length
                    };
                }
            }
        }

        if (detectedLineBreak) {
            detectionInfo.originalFormat = detectedLineBreak.type;
            detectionInfo.detectedPatterns.push({
                type: detectedLineBreak.type,
                count: detectedLineBreak.count
            });
        }

        // Ê≠£Ë¶èÂåñÔºà„Åô„Åπ„Å¶LF„Å´Áµ±‰∏ÄÔºâ
        const normalizedInput = processedInput.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

        return {
            lines: normalizedInput.split('\n'),
            info: detectionInfo
        };
    }

    function performValidation(lines) {
        const results = {
            total: lines.length,
            valid: 0,
            warnings: 0,
            errors: 0,
            records: [],
            version: null
        };

        lines.forEach((line, index) => {
            const fields = line.split(',');
            const recordType = fields[0];

            const recordResult = {
                lineNumber: index + 1,
                recordType: recordType,
                typeName: getRecordTypeName(recordType),
                fieldCount: fields.length,
                status: 'valid',
                issues: [],
                fields: fields
            };

            // „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÅÆÊäΩÂá∫
            if (index === 0) {
                results.version = recordType;
                validateVersion(recordType, recordResult);
            }

            // „É¨„Ç≥„Éº„Éâ„Çø„Ç§„ÉóÂà•„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            validateRecord(recordType, fields, recordResult);

            // ÁµêÊûú„ÅÆÈõÜË®à
            if (recordResult.status === 'error') {
                results.errors++;
            } else if (recordResult.status === 'warning') {
                results.warnings++;
            } else {
                results.valid++;
            }

            results.records.push(recordResult);
        });

        return results;
    }

    function validateVersion(version, recordResult) {
        if (version !== NSIPS_SPEC.expectedVersion) {
            recordResult.issues.push({
                type: 'warning',
                message: `„Éê„Éº„Ç∏„Éß„É≥‰∏ç‰∏ÄËá¥: ${version} (ÊúüÂæÖÂÄ§: ${NSIPS_SPEC.expectedVersion})`
            });
            recordResult.status = 'warning';
        }
    }

    function validateRecord(recordType, fields, recordResult) {
        if (recordType.startsWith('VER')) {
            validateHeaderRecord(fields, recordResult);
        } else if (recordType === '1') {
            validatePatientRecord(fields, recordResult);
        } else if (recordType === '2') {
            validatePrescriptionRecord(fields, recordResult);
        } else if (recordType === '3') {
            validateUsageRecord(fields, recordResult);
        } else if (recordType === '4') {
            validateMedicineRecord(fields, recordResult);
        } else if (['5', '6', '7', '8'].includes(recordType)) {
            validateOptionalRecord(recordType, fields, recordResult);
        } else {
            recordResult.issues.push({
                type: 'error',
                message: '‰∏çÊòé„Å™„É¨„Ç≥„Éº„Éâ„Çø„Ç§„Éó„Åß„Åô'
            });
            recordResult.status = 'error';
        }
    }

    function validateHeaderRecord(fields, recordResult) {
        NSIPS_SPEC.headerFields.forEach((spec, index) => {
            if (index >= fields.length) {
                if (spec.required) {
                    recordResult.issues.push({
                        type: 'error',
                        message: `ÂøÖÈ†àÈ†ÖÁõÆ„Åå‰∏çË∂≥: ${spec.name}`
                    });
                    recordResult.status = 'error';
                }
                return;
            }

            const value = fields[index];
            if (spec.required && (!value || value.trim() === '')) {
                recordResult.issues.push({
                    type: 'error',
                    message: `ÂøÖÈ†àÈ†ÖÁõÆ„ÅåÁ©∫ÁôΩ: ${spec.name}`
                });
                recordResult.status = 'error';
            }

            if (spec.pattern && value && !spec.pattern.test(value)) {
                recordResult.issues.push({
                    type: 'warning',
                    message: `„Éï„Ç©„Éº„Éû„ÉÉ„Éà‰∏çÊ≠£: ${spec.name} (${value})`
                });
                if (recordResult.status === 'valid') {
                    recordResult.status = 'warning';
                }
            }
        });
    }

    function validatePatientRecord(fields, recordResult) {
        if (fields.length < 6) {
            recordResult.issues.push({
                type: 'error',
                message: 'ÂøÖÈ†àÈ†ÖÁõÆ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô'
            });
            recordResult.status = 'error';
            return;
        }

        // ÊÄßÂà•„ÉÅ„Çß„ÉÉ„ÇØ
        if (fields[4] && !['0', '1', '2'].includes(fields[4])) {
            recordResult.issues.push({
                type: 'warning',
                message: `ÊÄßÂà•„Ç≥„Éº„Éâ„Åå‰∏çÊ≠£: ${fields[4]}`
            });
            if (recordResult.status === 'valid') {
                recordResult.status = 'warning';
            }
        }

        // ÁîüÂπ¥ÊúàÊó•„ÉÅ„Çß„ÉÉ„ÇØ
        if (fields[5] && !/^\d{8}$/.test(fields[5])) {
            recordResult.issues.push({
                type: 'warning',
                message: `ÁîüÂπ¥ÊúàÊó•„Éï„Ç©„Éº„Éû„ÉÉ„Éà‰∏çÊ≠£: ${fields[5]}`
            });
            if (recordResult.status === 'valid') {
                recordResult.status = 'warning';
            }
        }
    }

    function validatePrescriptionRecord(fields, recordResult) {
        if (fields.length < 15) {
            recordResult.issues.push({
                type: 'error',
                message: 'ÂøÖÈ†àÈ†ÖÁõÆ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô'
            });
            recordResult.status = 'error';
        }
    }

    function validateUsageRecord(fields, recordResult) {
        if (fields.length < 12) {
            recordResult.issues.push({
                type: 'error',
                message: 'ÂøÖÈ†àÈ†ÖÁõÆ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô'
            });
            recordResult.status = 'error';
        }
    }

    function validateMedicineRecord(fields, recordResult) {
        if (fields.length < 19) {
            recordResult.issues.push({
                type: 'error',
                message: 'ÂøÖÈ†àÈ†ÖÁõÆ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô'
            });
            recordResult.status = 'error';
        }
    }

    function validateOptionalRecord(recordType, fields, recordResult) {
        recordResult.issues.push({
            type: 'info',
            message: 'ÁúÅÁï•ÂèØÈ†ÖÁõÆ„Å®„Åó„Å¶Ê≠£Â∏∏„Å´Âá¶ÁêÜ„Åï„Çå„Åæ„Åó„Åü'
        });
    }

    function getRecordTypeName(recordType) {
        if (recordType.startsWith('VER')) {
            return '„Éò„ÉÉ„ÉÄÈÉ®';
        }
        const spec = NSIPS_SPEC.recordTypes[recordType];
        return spec ? spec.name : '‰∏çÊòé';
    }

    function displayResults(results) {
        const section = document.getElementById('resultsSection');
        const versionInfo = document.getElementById('versionInfo');
        const versionText = document.getElementById('versionText');
        const statsSection = document.getElementById('statsSection');
        const resultsDiv = document.getElementById('validationResults');

        // Áµ±Ë®àÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
        document.getElementById('totalRecords').textContent = results.total;
        document.getElementById('validRecords').textContent = results.valid;
        document.getElementById('warningRecords').textContent = results.warnings;
        document.getElementById('errorRecords').textContent = results.errors;

        // „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÅÆË°®Á§∫
        if (results.version) {
            versionText.textContent = results.version;
            versionInfo.classList.remove('hidden');
        }

        // ÊîπË°å„Ç≥„Éº„ÉâÊÉÖÂ†±„ÅÆË°®Á§∫
        let html = '';
        if (results.lineBreakInfo) {
            html += generateLineBreakInfo(results.lineBreakInfo);
        }

        // ÁµêÊûú„ÅÆË°®Á§∫
        results.records.forEach(record => {
            const statusClass = `result-${record.status}`;
            const icon = record.status === 'valid' ? '‚úÖ' :
                record.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';

            html += `
                    <div class="validation-result ${statusClass}">
                        <div class="record-header">
                            ${icon} Ë°å ${record.lineNumber}: ${record.typeName} (Ë≠òÂà•Â≠ê: ${record.recordType})
                        </div>

                        ${record.issues.length > 0 ? `
                            <div style="margin: 10px 0;">
                                ${record.issues.map(issue => `
                                    <div style="margin: 5px 0;">‚Ä¢ ${issue.message}</div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <div class="record-details">
                            <div style="margin-bottom: 10px;">
                                <strong>„Éï„Ç£„Éº„É´„ÉâÊï∞:</strong> ${record.fieldCount}
                            </div>
                            ${generateFieldDetails(record)}
                        </div>
                    </div>
                `;
        });

        resultsDiv.innerHTML = html;
        statsSection.classList.remove('hidden');
        section.classList.remove('hidden');

        // „Ç¢„Ç§„Ç≥„É≥„ÅÆÊõ¥Êñ∞
        const icon = results.errors > 0 ? '‚ùå' :
            results.warnings > 0 ? '‚ö†Ô∏è' : '‚úÖ';
        document.getElementById('resultsIcon').textContent = icon;
    }

    function generateLineBreakInfo(lineBreakInfo) {
        if (!lineBreakInfo.detectedPatterns.length && !lineBreakInfo.hasEscapeSequences) {
            return '';
        }

        let html = `
                <div class="validation-result" style="background: #f0f9ff; border-color: #0284c7; color: #0c4a6e;">
                    <div class="record-header">
                        üìù ÊîπË°å„Ç≥„Éº„ÉâÊ§úÂá∫ÁµêÊûú
                    </div>
                    <div style="margin: 10px 0;">
            `;

        if (lineBreakInfo.hasEscapeSequences) {
            html += `<div style="margin: 5px 0;">
                    <strong>„Ç®„Çπ„Ç±„Éº„Éó„Ç∑„Éº„Ç±„É≥„ÇπÊ§úÂá∫:</strong> „Éá„Éº„ÇøÂÜÖ„Å´„Ç®„Çπ„Ç±„Éº„ÉóÊñáÂ≠óÂàó„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åó„Åü
                </div>`;
        }

        if (lineBreakInfo.originalFormat !== 'unknown') {
            html += `<div style="margin: 5px 0;">
                    <strong>Ê§úÂá∫„Åï„Çå„ÅüÊîπË°åÂΩ¢Âºè:</strong> ${lineBreakInfo.originalFormat}
                </div>`;
        }

        if (lineBreakInfo.detectedPatterns.length > 0) {
            html += `<div style="margin: 5px 0;">
                    <strong>Ë©≥Á¥∞„Éë„Çø„Éº„É≥:</strong>
                    <ul style="margin: 5px 0 0 20px;">`;

            lineBreakInfo.detectedPatterns.forEach(pattern => {
                html += `<li>${pattern.type}: ${pattern.count}ÁÆáÊâÄ</li>`;
            });

            html += `</ul></div>`;
        }

        html += `<div style="margin: 5px 0; font-style: italic; color: #0369a1;">
                Ëá™ÂãïÁöÑ„Å´Ê®ôÊ∫ñÂΩ¢ÂºèÔºàLFÔºâ„Å´Ê≠£Ë¶èÂåñ„Åó„Å¶Âá¶ÁêÜ„Åó„Åæ„Åó„Åü
            </div></div></div>`;

        return html;
    }

    function generateFieldDetails(record) {
        let html = '';
        const maxDisplay = 10; // Ë°®Á§∫„Åô„ÇãÊúÄÂ§ß„Éï„Ç£„Éº„É´„ÉâÊï∞

        record.fields.slice(0, maxDisplay).forEach((field, index) => {
            const fieldName = getFieldName(record.recordType, index);
            const isEmpty = !field || field.trim() === '';

            html += `
                    <div class="field-info">
                        <div class="field-label">${index + 1}:</div>
                        <div class="field-value">${fieldName}</div>
                        <div class="field-status">
                            ${isEmpty ? '(Á©∫ÁôΩ)' : field.length > 30 ? field.substring(0, 30) + '...' : field}
                        </div>
                    </div>
                `;
        });

        if (record.fields.length > maxDisplay) {
            html += `<div style="text-align: center; color: #718096; margin-top: 10px;">
                    ‰ªñ ${record.fields.length - maxDisplay} „Éï„Ç£„Éº„É´„Éâ...
                </div>`;
        }

        return html;
    }

    function getFieldName(recordType, index) {
        if (recordType.startsWith('VER') && NSIPS_SPEC.headerFields[index]) {
            return NSIPS_SPEC.headerFields[index].name;
        }
        if (recordType === '1' && NSIPS_SPEC.patientFields[index]) {
            return NSIPS_SPEC.patientFields[index].name;
        }
        return `È†ÖÁï™${index + 1}`;
    }

    function loadSampleData() {
        const sampleData = `VER010603,20250722153322,,PCCLIENT1,14,4,0842302,„ÉÜ„Çπ„ÉàËñ¨Â±Ä,2360042,Á•ûÂ•àÂ∑ùÁúåÊ®™ÊµúÂ∏ÇÈáëÊ≤¢Âå∫„ÉÜ„Çπ„ÉàÁî∫1-2-3,0457111111,
1,,ÔæîÔæèÔæÄÔæû ÔæÄÔæõÔΩ≥,Â±±Áî∞„ÄÄÂ§™ÈÉé,1,19800101,2360045,Á•ûÂ•àÂ∑ùÁúåÊ®™ÊµúÂ∏ÇÈáëÊ≤¢Âå∫„Çµ„É≥„Éó„É´Áî∫4-5-6,,,08011112222,,2,2,144105,20230801,ÔºóÔºê,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,
2,990235520035206,41,U,20250722,,,20250722,0,0,0,206,0800052,14,„Çµ„É≥„Éó„É´ÁóÖÈô¢,2360037,Ê®™ÊµúÂ∏ÇÈáëÊ≤¢Âå∫„ÉÜ„Çπ„ÉàÊù±1-2-3,0457333333,49,ÂÜÖÁßë,,,794,ÔΩªÔæÑÔΩ≥ ÔΩºÔæûÔæõÔΩ≥,‰ΩêËó§„ÄÄÊ¨°ÈÉé,0,,,,,,,,,0,0,0,0,0,0,0,0
3,1,*1000,ÔºëÊó•ÔºëÂõû„ÄÄÊúùÈ£üÂæåÊúçÁî®,,,,,2,1,70,0,,1,0,0,,,,,,
4,1,1,1,3969010F2030,621951001,,ÔΩªÔæùÔæåÔæüÔæô50,„Çµ„É≥„Éó„É´Èå†ÔºïÔºêÔΩçÔΩá,„ÉÜ„Çπ„ÉàÊàêÂàÜÈå†ÔºïÔºêÔΩçÔΩá,0,0,0,0,0,0,1,1,Èå†,0,0,0,0,1,82.1,,,,,,,,0,,,,,,,,
5,560,0,0,0,448,0,0,0,0,0,0,560,0,0,0,0,0,0,0,0
6,1,0,8,70,560,0,560,,,,,,,,,,,,,,,,,,,,`;

        document.getElementById('dataInput').value = sampleData;
    }

    function loadEscapeSequenceData() {
        // „Ç®„Çπ„Ç±„Éº„Éó„Ç∑„Éº„Ç±„É≥„ÇπÂΩ¢Âºè„ÅÆ„Çµ„É≥„Éó„É´„Éá„Éº„Çø
        const escapeData = `VER010603,20250722153322,,PCCLIENT1,14,4,0842302,„ÉÜ„Çπ„ÉàËñ¨Â±Ä,2360042,Á•ûÂ•àÂ∑ùÁúåÊ®™ÊµúÂ∏ÇÈáëÊ≤¢Âå∫„ÉÜ„Çπ„ÉàÁî∫1-2-3,0457111111,\\n1,,ÔæîÔæèÔæÄÔæû ÔæÄÔæõÔΩ≥,Â±±Áî∞„ÄÄÂ§™ÈÉé,1,19800101,2360045,Á•ûÂ•àÂ∑ùÁúåÊ®™ÊµúÂ∏ÇÈáëÊ≤¢Âå∫„Çµ„É≥„Éó„É´Áî∫4-5-6,,,08011112222,,2,2,144105,20230801,ÔºóÔºê,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,\\n2,990235520035206,41,U,20250722,,,20250722,0,0,0,206,0800052,14,„Çµ„É≥„Éó„É´ÁóÖÈô¢,2360037,Ê®™ÊµúÂ∏ÇÈáëÊ≤¢Âå∫„ÉÜ„Çπ„ÉàÊù±1-2-3,0457333333,49,ÂÜÖÁßë,,,794,ÔΩªÔæÑÔΩ≥ ÔΩºÔæûÔæõÔΩ≥,‰ΩêËó§„ÄÄÊ¨°ÈÉé,0,,,,,,,,,0,0,0,0,0,0,0,0\\n3,1,*1000,ÔºëÊó•ÔºëÂõû„ÄÄÊúùÈ£üÂæåÊúçÁî®,,,,,2,1,70,0,,1,0,0,,,,,,\\n4,1,1,1,3969010F2030,621951001,,ÔΩªÔæùÔæåÔæüÔæô50,„Çµ„É≥„Éó„É´Èå†ÔºïÔºêÔΩçÔΩá,„ÉÜ„Çπ„ÉàÊàêÂàÜÈå†ÔºïÔºêÔΩçÔΩá,0,0,0,0,0,0,1,1,Èå†,0,0,0,0,1,82.1,,,,,,,,0,,,,,,,,`;

        document.getElementById('dataInput').value = escapeData;
    }

    function clearData() {
        document.getElementById('dataInput').value = '';
        document.getElementById('resultsSection').classList.add('hidden');
    }

    function showError(message) {
        const section = document.getElementById('resultsSection');
        const resultsDiv = document.getElementById('validationResults');

        resultsDiv.innerHTML = `
                <div class="validation-result result-error">
                    <div class="record-header">‚ùå „Ç®„É©„Éº</div>
                    <div>${message}</div>
                </div>
            `;

        document.getElementById('statsSection').classList.add('hidden');
        document.getElementById('versionInfo').classList.add('hidden');
        section.classList.remove('hidden');
    }

    // ÂàùÊúüÂåñ
    document.addEventListener('DOMContentLoaded', function() {
        console.log('NSIPS„Éá„Éº„Çø„Éê„É™„Éá„Éº„Çø„Éº Ver. 1.06.03 ÂØæÂøúÁâà„ÅåË™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„Åü');
    });
</script>
</body>
</html>