<div class="main-content">
    <!-- ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="tab-container">
        <button class="tab active" onclick="switchTab('validator')">
            <div class="tab-icon">ğŸ”</div>
            <div class="tab-title">NSIPSãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼</div>
            <div class="tab-subtitle">ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ„ãƒ¼ãƒ«</div>
        </button>
        <button class="tab" onclick="switchTab('formatter')">
            <div class="tab-icon">ğŸ¨</div>
            <div class="tab-title">ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼</div>
            <div class="tab-subtitle">JSON/CSVæ•´å½¢ãƒ„ãƒ¼ãƒ«</div>
        </button>
        <button class="tab" onclick="switchTab('converter')">
            <div class="tab-icon">ğŸ”„</div>
            <div class="tab-title">ãƒ‡ãƒ¼ã‚¿å¤‰æ›å™¨</div>
            <div class="tab-subtitle">å½¢å¼å¤‰æ›ãƒ„ãƒ¼ãƒ«</div>
        </button>
    </div>

    <!-- NSIPSãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã‚¿ãƒ– -->
    <div id="validatorTab" class="tab-content active">
        <div class="tool-section" data-tool="VALIDATOR">
            <h3>ğŸ” NSIPSãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</h3>
            <textarea id="dataInput" placeholder="NSIPSãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„...&#10;&#10;ğŸ“ ã‚µãƒãƒ¼ãƒˆã™ã‚‹æ”¹è¡Œå½¢å¼:&#10;â€¢ Windowså½¢å¼ (CRLF: \r\n)&#10;â€¢ Unix/Linuxå½¢å¼ (LF: \n)&#10;â€¢ Classic Macå½¢å¼ (CR: \r)&#10;â€¢ ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ (\n, \r\n, \r)&#10;&#10;ä¾‹:&#10;VER010603,20250722153322,,PCCLIENT1,14,4,0842302,ãƒ†ã‚¹ãƒˆè–¬å±€,2360042,ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚é‡‘æ²¢åŒºãƒ†ã‚¹ãƒˆç”º1-2-3,0457111111,&#10;1,,ï¾”ï¾ï¾€ï¾ ï¾€ï¾›ï½³,å±±ç”°ã€€å¤ªéƒ,1,19800101,2360045,ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚é‡‘æ²¢åŒºã‚µãƒ³ãƒ—ãƒ«ç”º4-5-6,,,08011112222,,2,2,144105,20230801,ï¼—ï¼,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,"></textarea>

            <div class="button-group">
                <button class="btn btn-primary" onclick="validateData()">
                    <span>ğŸ”</span>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                </button>
                <button class="btn btn-secondary" onclick="loadSampleData()">
                    <span>ğŸ“„</span>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­è¾¼
                </button>
                <button class="btn btn-secondary" onclick="loadEscapeSequenceData()">
                    <span>ğŸ”¤</span>ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å½¢å¼ã‚µãƒ³ãƒ—ãƒ«
                </button>
                <button class="btn btn-secondary" onclick="clearData()">
                    <span>ğŸ—‘ï¸</span>ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚¿ãƒ– -->
    <div id="formatterTab" class="tab-content">
        <div class="tool-section" data-tool="FORMATTER">
            <h3>ğŸ¨ ãƒ‡ãƒ¼ã‚¿æ•´å½¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>

            <div class="formatter-controls">
                <div class="format-option selected" onclick="selectFormat('json')">
                    <input type="radio" name="format" value="json" checked>
                    <span>ğŸ“„ JSONæ•´å½¢</span>
                </div>
                <div class="format-option" onclick="selectFormat('csv')">
                    <input type="radio" name="format" value="csv">
                    <span>ğŸ“Š CSVæ•´å½¢</span>
                </div>
                <div class="format-option" onclick="selectFormat('minify')">
                    <input type="radio" name="format" value="minify">
                    <span>ğŸ—œï¸ JSONåœ§ç¸®</span>
                </div>
            </div>

            <textarea id="formatterInput" placeholder="æ•´å½¢ã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„...&#10;&#10;ğŸ“ ã‚µãƒãƒ¼ãƒˆå½¢å¼:&#10;â€¢ JSON (ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ»é…åˆ—)&#10;â€¢ CSV (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)&#10;â€¢ TSV (ã‚¿ãƒ–åŒºåˆ‡ã‚Š)&#10;â€¢ æ”¹è¡ŒåŒºåˆ‡ã‚Šãƒ‡ãƒ¼ã‚¿&#10;&#10;ä¾‹ (JSON):&#10;{&quot;name&quot;:&quot;ãƒ†ã‚¹ãƒˆ&quot;,&quot;value&quot;:123}&#10;&#10;ä¾‹ (CSV):&#10;name,value&#10;ãƒ†ã‚¹ãƒˆ,123"></textarea>

            <div class="button-group">
                <button class="btn btn-primary" onclick="formatData()">
                    <span>ğŸ¨</span>ãƒ‡ãƒ¼ã‚¿æ•´å½¢å®Ÿè¡Œ
                </button>
                <button class="btn btn-secondary" onclick="loadFormatterSample()">
                    <span>ğŸ“„</span>ã‚µãƒ³ãƒ—ãƒ«èª­è¾¼
                </button>
                <button class="btn btn-secondary" onclick="clearFormatter()">
                    <span>ğŸ—‘ï¸</span>ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿å¤‰æ›å™¨ã‚¿ãƒ– -->
    <div id="converterTab" class="tab-content">
        <div class="tool-section" data-tool="CONVERTER">
            <h3>ğŸ”„ ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>

            <div class="formatter-controls">
                <div class="format-option selected" onclick="selectConverter('json-to-csv')">
                    <input type="radio" name="converter" value="json-to-csv" checked>
                    <span>ğŸ“„â¡ï¸ğŸ“Š JSON â†’ CSV</span>
                </div>
                <div class="format-option" onclick="selectConverter('csv-to-json')">
                    <input type="radio" name="converter" value="csv-to-json">
                    <span>ğŸ“Šâ¡ï¸ğŸ“„ CSV â†’ JSON</span>
                </div>
                <div class="format-option" onclick="selectConverter('nsips-to-json')">
                    <input type="radio" name="converter" value="nsips-to-json">
                    <span>ğŸ¥â¡ï¸ğŸ“„ NSIPS â†’ JSON</span>
                </div>
            </div>

            <textarea id="converterInput" placeholder="å¤‰æ›ã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„...&#10;&#10;ğŸ”„ å¤‰æ›ãƒ‘ã‚¿ãƒ¼ãƒ³:&#10;â€¢ JSON â†’ CSV: JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’CSVå½¢å¼ã«å¤‰æ›&#10;â€¢ CSV â†’ JSON: CSVå½¢å¼ã‚’JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›&#10;â€¢ NSIPS â†’ JSON: NSIPSãƒ‡ãƒ¼ã‚¿ã‚’æ§‹é€ åŒ–JSONã«å¤‰æ›&#10;&#10;ä¾‹ (JSON â†’ CSV):&#10;[{&quot;name&quot;:&quot;ãƒ†ã‚¹ãƒˆ&quot;,&quot;age&quot;:25},{&quot;name&quot;:&quot;ã‚µãƒ³ãƒ—ãƒ«&quot;,&quot;age&quot;:30}]"></textarea>

            <div class="button-group">
                <button class="btn btn-primary" onclick="convertData()">
                    <span>ğŸ”„</span>ãƒ‡ãƒ¼ã‚¿å¤‰æ›å®Ÿè¡Œ
                </button>
                <button class="btn btn-secondary" onclick="loadConverterSample()">
                    <span>ğŸ“„</span>ã‚µãƒ³ãƒ—ãƒ«èª­è¾¼
                </button>
                <button class="btn btn-secondary" onclick="clearConverter()">
                    <span>ğŸ—‘ï¸</span>ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>
    </div><!DOCTYPE html>
    <html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>NSIPSãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            // åˆæœŸåŒ–
            document.addEventListener('DOMContentLoaded', function() {
                console.log('åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ Ver. 1.06.03 å¯¾å¿œç‰ˆãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã‚¿ãƒ–ã‚’è¡¨ç¤º
            switchTab('validator');
            });

                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    padding: 20px;
                    color: #333;
                }

                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                    overflow: hidden;
                }

                .header {
                    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
                    color: white;
                    padding: 30px;
                    text-align: center;
                }

                .header h1 {
                    font-size: 2.5rem;
                    margin-bottom: 10px;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                }

                .header p {
                    font-size: 1.1rem;
                    opacity: 0.9;
                }

                .main-content {
                    padding: 30px;
                }

                .input-section {
                    background: #f7fafc;
                    border-radius: 15px;
                    padding: 25px;
                    margin-bottom: 30px;
                    border: 2px solid #e2e8f0;
                }

                .input-section h2 {
                    color: #2d3748;
                    margin-bottom: 15px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .input-section h2::before {
                    content: "ğŸ“";
                    font-size: 1.5rem;
                }

                textarea {
                    width: 100%;
                    height: 200px;
                    padding: 15px;
                    border: 2px solid #cbd5e0;
                    border-radius: 10px;
                    font-family: 'Courier New', monospace;
                    font-size: 14px;
                    resize: vertical;
                    transition: border-color 0.3s ease;
                }

                textarea:focus {
                    outline: none;
                    border-color: #667eea;
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                }

                .button-group {
                    display: flex;
                    gap: 15px;
                    margin-top: 20px;
                    flex-wrap: wrap;
                }

                .btn {
                    padding: 12px 24px;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }

                .btn-primary {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                }

                .btn-primary:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
                }

                .btn-secondary {
                    background: #f7fafc;
                    color: #4a5568;
                    border: 2px solid #e2e8f0;
                }

                .btn-secondary:hover {
                    background: #edf2f7;
                    border-color: #cbd5e0;
                }

                .results-section {
                    background: #ffffff;
                    border-radius: 15px;
                    padding: 25px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                    border: 1px solid #e2e8f0;
                }

                .results-section h2 {
                    color: #2d3748;
                    margin-bottom: 20px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .validation-result {
                    margin-bottom: 20px;
                    padding: 15px;
                    border-radius: 10px;
                    border-left: 4px solid;
                }

                .result-success {
                    background: #f0fff4;
                    border-color: #38a169;
                    color: #2f855a;
                }

                .result-warning {
                    background: #fffbeb;
                    border-color: #ed8936;
                    color: #c05621;
                }

                .result-error {
                    background: #fed7d7;
                    border-color: #e53e3e;
                    color: #c53030;
                }

                .record-details {
                    background: #f7fafc;
                    border-radius: 8px;
                    padding: 15px;
                    margin-top: 15px;
                    font-family: 'Courier New', monospace;
                    font-size: 12px;
                    max-height: 300px;
                    overflow-y: auto;
                }

                .record-header {
                    font-weight: bold;
                    color: #2d3748;
                    margin-bottom: 10px;
                    padding-bottom: 5px;
                    border-bottom: 1px solid #cbd5e0;
                }

                .field-info {
                    display: grid;
                    grid-template-columns: 100px 200px 1fr;
                    gap: 10px;
                    margin-bottom: 8px;
                    padding: 5px;
                    background: white;
                    border-radius: 4px;
                }

                .field-label {
                    font-weight: bold;
                    color: #4a5568;
                }

                .field-value {
                    color: #2d3748;
                    word-break: break-all;
                }

                .field-status {
                    color: #718096;
                    font-style: italic;
                }

                .stats {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }

                .stat-card {
                    background: white;
                    padding: 20px;
                    border-radius: 12px;
                    text-align: center;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                    border: 1px solid #e2e8f0;
                }

                .stat-number {
                    font-size: 2rem;
                    font-weight: bold;
                    color: #667eea;
                    display: block;
                }

                .stat-label {
                    color: #718096;
                    margin-top: 5px;
                }

                .version-info {
                    background: #ebf8ff;
                    border: 1px solid #bee3f8;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 20px;
                }

                .tab-container {
                    display: flex;
                    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
                    border-radius: 15px;
                    padding: 8px;
                    margin-bottom: 20px;
                    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
                    gap: 8px;
                    flex-wrap: wrap;
                }

                .tab {
                    flex: 1;
                    min-width: 200px;
                    padding: 16px 20px;
                    background: white;
                    border: 2px solid transparent;
                    border-radius: 12px;
                    cursor: pointer;
                    font-weight: 600;
                    transition: all 0.4s ease;
                    color: #4a5568;
                    text-align: center;
                    position: relative;
                    overflow: hidden;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                }

                .tab::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
                    transition: left 0.5s ease;
                }

                .tab:hover::before {
                    left: 100%;
                }

                .tab.active {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border-color: #5a67d8;
                    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
                    transform: translateY(-2px);
                }

                .tab:hover:not(.active) {
                    background: #f1f5f9;
                    border-color: #cbd5e0;
                    transform: translateY(-1px);
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                }

                .tab-icon {
                    font-size: 1.5rem;
                    display: block;
                    margin-bottom: 8px;
                }

                .tab-title {
                    font-size: 0.95rem;
                    font-weight: 700;
                }

                .tab-subtitle {
                    font-size: 0.75rem;
                    opacity: 0.8;
                    margin-top: 4px;
                }

                .tab-content {
                    display: none;
                    background: white;
                    border-radius: 20px;
                    padding: 30px;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
                    border: 1px solid #e2e8f0;
                    position: relative;
                    overflow: hidden;
                }

                .tab-content::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 4px;
                    background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
                }

                .tab-content.active {
                    display: block;
                    animation: fadeInUp 0.5s ease;
                }

                @keyframes fadeInUp {
                    from {
                        opacity: 0;
                        transform: translateY(20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                .tool-section {
                    background: #f8fafc;
                    border-radius: 15px;
                    padding: 25px;
                    margin-bottom: 25px;
                    border-left: 4px solid #667eea;
                    position: relative;
                }

                .tool-section::before {
                    content: attr(data-tool);
                    position: absolute;
                    top: -12px;
                    left: 20px;
                    background: #667eea;
                    color: white;
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                }

                .tool-section h3 {
                    color: #2d3748;
                    margin-bottom: 15px;
                    margin-top: 10px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .format-option {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    padding: 12px 16px;
                    background: white;
                    border: 2px solid #e2e8f0;
                    border-radius: 12px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;
                }

                .format-option::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
                    transition: left 0.4s ease;
                }

                .format-option:hover::before {
                    left: 100%;
                }

                .format-option:hover {
                    border-color: #667eea;
                    transform: translateY(-1px);
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
                }

                .format-option.selected {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border-color: #5a67d8;
                    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
                }

                .format-option input[type="radio"] {
                    margin: 0;
                    transform: scale(1.2);
                }

                .formatter-controls {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                    margin-bottom: 25px;
                }

                .hidden {
                    display: none;
                }
                .container {
                    margin: 10px;
                    border-radius: 15px;
                }

                .main-content {
                    padding: 20px;
                }

                .button-group {
                    flex-direction: column;
                }

                .field-info {
                    grid-template-columns: 1fr;
                    gap: 5px;
                }
            }
        </style>
    </head>
    <body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§° åŒ»ç™‚ãƒ‡ãƒ¼ã‚¿ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹</h1>
            <p>NSIPS ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ & ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ - æ–°èª¿å‰¤ã‚·ã‚¹ãƒ†ãƒ æ¨™æº–IFå¯¾å¿œ</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2>NSIPSãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                <textarea id="dataInput" placeholder="NSIPSãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„...&#10;&#10;ğŸ“ ã‚µãƒãƒ¼ãƒˆã™ã‚‹æ”¹è¡Œå½¢å¼:&#10;â€¢ Windowså½¢å¼ (CRLF: \r\n)&#10;â€¢ Unix/Linuxå½¢å¼ (LF: \n)&#10;â€¢ Classic Macå½¢å¼ (CR: \r)&#10;â€¢ ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ (\n, \r\n, \r)&#10;&#10;ä¾‹:&#10;VER010603,20250722153322,,PCCLIENT1,14,4,0842302,ãƒ†ã‚¹ãƒˆè–¬å±€,2360042,ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚é‡‘æ²¢åŒºãƒ†ã‚¹ãƒˆç”º1-2-3,0457111111,&#10;1,,ï¾”ï¾ï¾€ï¾ ï¾€ï¾›ï½³,å±±ç”°ã€€å¤ªéƒ,1,19800101,2360045,ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚é‡‘æ²¢åŒºã‚µãƒ³ãƒ—ãƒ«ç”º4-5-6,,,08011112222,,2,2,144105,20230801,ï¼—ï¼,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,"></textarea>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="validateData()">
                        <span>ğŸ”</span>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                    </button>
                    <button class="btn btn-secondary" onclick="loadSampleData()">
                        <span>ğŸ“„</span>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­è¾¼
                    </button>
                    <button class="btn btn-secondary" onclick="loadEscapeSequenceData()">
                        <span>ğŸ”¤</span>ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å½¢å¼ã‚µãƒ³ãƒ—ãƒ«
                    </button>
                    <button class="btn btn-secondary" onclick="clearData()">
                        <span>ğŸ—‘ï¸</span>ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>

            <div id="resultsSection" class="results-section hidden">
                <h2><span id="resultsIcon">ğŸ“Š</span>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</h2>

                <div id="versionInfo" class="version-info hidden">
                    <strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±:</strong> <span id="versionText"></span>
                </div>

                <div id="statsSection" class="stats hidden">
                    <div class="stat-card">
                        <span class="stat-number" id="totalRecords">0</span>
                        <div class="stat-label">ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="validRecords">0</span>
                        <div class="stat-label">æœ‰åŠ¹ãƒ¬ã‚³ãƒ¼ãƒ‰</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="warningRecords">0</span>
                        <div class="stat-label">è­¦å‘Š</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="errorRecords">0</span>
                        <div class="stat-label">ã‚¨ãƒ©ãƒ¼</div>
                    </div>
                </div>

                <div id="validationResults"></div>
            </div>
        </div>
    </div>

    <script>
        // NSIPSä»•æ§˜å®šç¾©
        const NSIPS_SPEC = {
            version: "1.06.03",
            expectedVersion: "VER010603",

            recordTypes: {
                'HEADER': { id: 'VER', name: 'ãƒ˜ãƒƒãƒ€éƒ¨', required: true },
                '1': { id: '1', name: 'æ‚£è€…æƒ…å ±éƒ¨', required: true },
                '2': { id: '2', name: 'å‡¦æ–¹ç®‹æƒ…å ±éƒ¨', required: true },
                '3': { id: '3', name: 'ç”¨æ³•éƒ¨', required: true },
                '4': { id: '4', name: 'è–¬å“éƒ¨', required: true },
                '5': { id: '5', name: 'èª¿å‰¤éŒ²éƒ¨', required: false },
                '6': { id: '6', name: 'èª¿å‰¤éŒ²æ˜ç´°éƒ¨', required: false },
                '7': { id: '7', name: 'åŸºæœ¬æ–™ãƒ»è–¬å­¦ç®¡ç†æ–™æƒ…å ±éƒ¨', required: false },
                '8': { id: '8', name: 'ãŠè–¬æ‰‹å¸³æƒ…å ±éƒ¨', required: false }
            },

            headerFields: [
                { name: "ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±", required: true, pattern: /^VER\d{6}$/ },
                { name: "é€ä¿¡æ—¥æ™‚", required: true, pattern: /^\d{14}$/ },
                { name: "å‚™è€ƒ", required: false },
                { name: "é€ä¿¡ç«¯æœ«è­˜åˆ¥æƒ…å ±", required: false },
                { name: "éƒ½é“åºœçœŒç•ªå·", required: true, pattern: /^\d{2}$/ },
                { name: "ç‚¹æ•°è¡¨", required: true, pattern: /^4$/ },
                { name: "è–¬å±€ã‚³ãƒ¼ãƒ‰", required: true, pattern: /^\d{7}$/ },
                { name: "è–¬å±€å", required: true },
                { name: "è–¬å±€éƒµä¾¿ç•ªå·", required: true, pattern: /^\d{7}$/ },
                { name: "è–¬å±€æ‰€åœ¨åœ°", required: true },
                { name: "è–¬å±€é›»è©±ç•ªå·", required: true, pattern: /^\d+$/ },
                { name: "æ—§ãƒ•ã‚¡ã‚¤ãƒ«å", required: false }
            ],

            patientFields: [
                { name: "è­˜åˆ¥å­", required: true, pattern: /^1$/ },
                { name: "æ‚£è€…ã‚³ãƒ¼ãƒ‰", required: true },
                { name: "æ‚£è€…ã‚«ãƒŠæ°å", required: true },
                { name: "æ‚£è€…æ¼¢å­—æ°å", required: true },
                { name: "æ€§åˆ¥", required: true, pattern: /^[012]$/ },
                { name: "ç”Ÿå¹´æœˆæ—¥", required: true, pattern: /^\d{8}$/ }
            ]
        };

        function validateData() {
            const input = document.getElementById('dataInput').value.trim();

            if (!input) {
                showError('ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            try {
                const processedData = normalizeLineBreaks(input);
                const lines = processedData.lines.filter(line => line.trim());
                const results = performValidation(lines);
                results.lineBreakInfo = processedData.info;
                displayResults(results);
            } catch (error) {
                showError('ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function normalizeLineBreaks(input) {
            // æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã®æ¤œå‡ºã¨æ­£è¦åŒ–
            const detectionInfo = {
                originalFormat: 'unknown',
                hasEscapeSequences: false,
                detectedPatterns: [],
                processedInput: input
            };

            // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®æ¤œå‡º
            const escapePatterns = [
                { pattern: /\\r\\n/g, type: 'CRLF escape (\\r\\n)', replacement: '\r\n' },
                { pattern: /\\n/g, type: 'LF escape (\\n)', replacement: '\n' },
                { pattern: /\\r/g, type: 'CR escape (\\r)', replacement: '\r' }
            ];

            let processedInput = input;

            // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®æ¤œå‡ºã¨å¤‰æ›
            escapePatterns.forEach(({ pattern, type, replacement }) => {
                const matches = input.match(pattern);
                if (matches) {
                    detectionInfo.hasEscapeSequences = true;
                    detectionInfo.detectedPatterns.push({
                        type: type,
                        count: matches.length
                    });
                    processedInput = processedInput.replace(pattern, replacement);
                }
            });

            // å®Ÿéš›ã®æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã®æ¤œå‡º
            const lineBreakPatterns = [
                { pattern: /\r\n/g, type: 'CRLF (Windows)', name: 'crlf' },
                { pattern: /\n/g, type: 'LF (Unix/Linux)', name: 'lf' },
                { pattern: /\r/g, type: 'CR (Classic Mac)', name: 'cr' }
            ];

            let detectedLineBreak = null;
            for (const { pattern, type, name } of lineBreakPatterns) {
                const matches = processedInput.match(pattern);
                if (matches && matches.length > 0) {
                    if (!detectedLineBreak || matches.length > detectedLineBreak.count) {
                        detectedLineBreak = {
                            type: type,
                            name: name,
                            count: matches.length
                        };
                    }
                }
            }

            if (detectedLineBreak) {
                detectionInfo.originalFormat = detectedLineBreak.type;
                detectionInfo.detectedPatterns.push({
                    type: detectedLineBreak.type,
                    count: detectedLineBreak.count
                });
            }

            // æ­£è¦åŒ–ï¼ˆã™ã¹ã¦LFã«çµ±ä¸€ï¼‰
            const normalizedInput = processedInput.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

            return {
                lines: normalizedInput.split('\n'),
                info: detectionInfo
            };
        }

        function performValidation(lines) {
            const results = {
                total: lines.length,
                valid: 0,
                warnings: 0,
                errors: 0,
                records: [],
                version: null
            };

            lines.forEach((line, index) => {
                const fields = line.split(',');
                const recordType = fields[0];

                const recordResult = {
                    lineNumber: index + 1,
                    recordType: recordType,
                    typeName: getRecordTypeName(recordType),
                    fieldCount: fields.length,
                    status: 'valid',
                    issues: [],
                    fields: fields
                };

                // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®æŠ½å‡º
                if (index === 0) {
                    results.version = recordType;
                    validateVersion(recordType, recordResult);
                }

                // ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—åˆ¥ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                validateRecord(recordType, fields, recordResult);

                // çµæœã®é›†è¨ˆ
                if (recordResult.status === 'error') {
                    results.errors++;
                } else if (recordResult.status === 'warning') {
                    results.warnings++;
                } else {
                    results.valid++;
                }

                results.records.push(recordResult);
            });

            return results;
        }

        function validateVersion(version, recordResult) {
            if (version !== NSIPS_SPEC.expectedVersion) {
                recordResult.issues.push({
                    type: 'warning',
                    message: `ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´: ${version} (æœŸå¾…å€¤: ${NSIPS_SPEC.expectedVersion})`
                });
                recordResult.status = 'warning';
            }
        }

        function validateRecord(recordType, fields, recordResult) {
            if (recordType.startsWith('VER')) {
                validateHeaderRecord(fields, recordResult);
            } else if (recordType === '1') {
                validatePatientRecord(fields, recordResult);
            } else if (recordType === '2') {
                validatePrescriptionRecord(fields, recordResult);
            } else if (recordType === '3') {
                validateUsageRecord(fields, recordResult);
            } else if (recordType === '4') {
                validateMedicineRecord(fields, recordResult);
            } else if (['5', '6', '7', '8'].includes(recordType)) {
                validateOptionalRecord(recordType, fields, recordResult);
            } else {
                recordResult.issues.push({
                    type: 'error',
                    message: 'ä¸æ˜ãªãƒ¬ã‚³ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã§ã™'
                });
                recordResult.status = 'error';
            }
        }

        function validateHeaderRecord(fields, recordResult) {
            NSIPS_SPEC.headerFields.forEach((spec, index) => {
                if (index >= fields.length) {
                    if (spec.required) {
                        recordResult.issues.push({
                            type: 'error',
                            message: `å¿…é ˆé …ç›®ãŒä¸è¶³: ${spec.name}`
                        });
                        recordResult.status = 'error';
                    }
                    return;
                }

                const value = fields[index];
                if (spec.required && (!value || value.trim() === '')) {
                    recordResult.issues.push({
                        type: 'error',
                        message: `å¿…é ˆé …ç›®ãŒç©ºç™½: ${spec.name}`
                    });
                    recordResult.status = 'error';
                }

                if (spec.pattern && value && !spec.pattern.test(value)) {
                    recordResult.issues.push({
                        type: 'warning',
                        message: `ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸æ­£: ${spec.name} (${value})`
                    });
                    if (recordResult.status === 'valid') {
                        recordResult.status = 'warning';
                    }
                }
            });
        }

        function validatePatientRecord(fields, recordResult) {
            if (fields.length < 6) {
                recordResult.issues.push({
                    type: 'error',
                    message: 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã¾ã™'
                });
                recordResult.status = 'error';
                return;
            }

            // æ€§åˆ¥ãƒã‚§ãƒƒã‚¯
            if (fields[4] && !['0', '1', '2'].includes(fields[4])) {
                recordResult.issues.push({
                    type: 'warning',
                    message: `æ€§åˆ¥ã‚³ãƒ¼ãƒ‰ãŒä¸æ­£: ${fields[4]}`
                });
                if (recordResult.status === 'valid') {
                    recordResult.status = 'warning';
                }
            }

            // ç”Ÿå¹´æœˆæ—¥ãƒã‚§ãƒƒã‚¯
            if (fields[5] && !/^\d{8}$/.test(fields[5])) {
                recordResult.issues.push({
                    type: 'warning',
                    message: `ç”Ÿå¹´æœˆæ—¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸æ­£: ${fields[5]}`
                });
                if (recordResult.status === 'valid') {
                    recordResult.status = 'warning';
                }
            }
        }

        function validatePrescriptionRecord(fields, recordResult) {
            if (fields.length < 15) {
                recordResult.issues.push({
                    type: 'error',
                    message: 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã¾ã™'
                });
                recordResult.status = 'error';
            }
        }

        function validateUsageRecord(fields, recordResult) {
            if (fields.length < 12) {
                recordResult.issues.push({
                    type: 'error',
                    message: 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã¾ã™'
                });
                recordResult.status = 'error';
            }
        }

        function validateMedicineRecord(fields, recordResult) {
            if (fields.length < 19) {
                recordResult.issues.push({
                    type: 'error',
                    message: 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã¾ã™'
                });
                recordResult.status = 'error';
            }
        }

        function validateOptionalRecord(recordType, fields, recordResult) {
            recordResult.issues.push({
                type: 'info',
                message: 'çœç•¥å¯é …ç›®ã¨ã—ã¦æ­£å¸¸ã«å‡¦ç†ã•ã‚Œã¾ã—ãŸ'
            });
        }

        function getRecordTypeName(recordType) {
            if (recordType.startsWith('VER')) {
                return 'ãƒ˜ãƒƒãƒ€éƒ¨';
            }
            const spec = NSIPS_SPEC.recordTypes[recordType];
            return spec ? spec.name : 'ä¸æ˜';
        }

        function displayResults(results) {
            const section = document.getElementById('resultsSection');
            const versionInfo = document.getElementById('versionInfo');
            const versionText = document.getElementById('versionText');
            const statsSection = document.getElementById('statsSection');
            const resultsDiv = document.getElementById('validationResults');

            // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
            document.getElementById('totalRecords').textContent = results.total;
            document.getElementById('validRecords').textContent = results.valid;
            document.getElementById('warningRecords').textContent = results.warnings;
            document.getElementById('errorRecords').textContent = results.errors;

            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®è¡¨ç¤º
            if (results.version) {
                versionText.textContent = results.version;
                versionInfo.classList.remove('hidden');
            }

            // æ”¹è¡Œã‚³ãƒ¼ãƒ‰æƒ…å ±ã®è¡¨ç¤º
            let html = '';
            if (results.lineBreakInfo) {
                html += generateLineBreakInfo(results.lineBreakInfo);
            }

            // çµæœã®è¡¨ç¤º
            results.records.forEach(record => {
                const statusClass = `result-${record.status}`;
                const icon = record.status === 'valid' ? 'âœ…' :
                    record.status === 'warning' ? 'âš ï¸' : 'âŒ';

                html += `
                    <div class="validation-result ${statusClass}">
                        <div class="record-header">
                            ${icon} è¡Œ ${record.lineNumber}: ${record.typeName} (è­˜åˆ¥å­: ${record.recordType})
                        </div>

                        ${record.issues.length > 0 ? `
                            <div style="margin: 10px 0;">
                                ${record.issues.map(issue => `
                                    <div style="margin: 5px 0;">â€¢ ${issue.message}</div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <div class="record-details">
                            <div style="margin-bottom: 10px;">
                                <strong>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°:</strong> ${record.fieldCount}
                            </div>
                            ${generateFieldDetails(record)}
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
            statsSection.classList.remove('hidden');
            section.classList.remove('hidden');

            // ã‚¢ã‚¤ã‚³ãƒ³ã®æ›´æ–°
            const icon = results.errors > 0 ? 'âŒ' :
                results.warnings > 0 ? 'âš ï¸' : 'âœ…';
            document.getElementById('resultsIcon').textContent = icon;
        }

        function generateLineBreakInfo(lineBreakInfo) {
            if (!lineBreakInfo.detectedPatterns.length && !lineBreakInfo.hasEscapeSequences) {
                return '';
            }

            let html = `
                <div class="validation-result" style="background: #f0f9ff; border-color: #0284c7; color: #0c4a6e;">
                    <div class="record-header">
                        ğŸ“ æ”¹è¡Œã‚³ãƒ¼ãƒ‰æ¤œå‡ºçµæœ
                    </div>
                    <div style="margin: 10px 0;">
            `;

            if (lineBreakInfo.hasEscapeSequences) {
                html += `<div style="margin: 5px 0;">
                    <strong>ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹æ¤œå‡º:</strong> ãƒ‡ãƒ¼ã‚¿å†…ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–‡å­—åˆ—ãŒå«ã¾ã‚Œã¦ã„ã¾ã—ãŸ
                </div>`;
            }

            if (lineBreakInfo.originalFormat !== 'unknown') {
                html += `<div style="margin: 5px 0;">
                    <strong>æ¤œå‡ºã•ã‚ŒãŸæ”¹è¡Œå½¢å¼:</strong> ${lineBreakInfo.originalFormat}
                </div>`;
            }

            if (lineBreakInfo.detectedPatterns.length > 0) {
                html += `<div style="margin: 5px 0;">
                    <strong>è©³ç´°ãƒ‘ã‚¿ãƒ¼ãƒ³:</strong>
                    <ul style="margin: 5px 0 0 20px;">`;

                lineBreakInfo.detectedPatterns.forEach(pattern => {
                    html += `<li>${pattern.type}: ${pattern.count}ç®‡æ‰€</li>`;
                });

                html += `</ul></div>`;
            }

            html += `<div style="margin: 5px 0; font-style: italic; color: #0369a1;">
                è‡ªå‹•çš„ã«æ¨™æº–å½¢å¼ï¼ˆLFï¼‰ã«æ­£è¦åŒ–ã—ã¦å‡¦ç†ã—ã¾ã—ãŸ
            </div></div></div>`;

            return html;
        }

        function generateFieldDetails(record) {
            let html = '';
            const maxDisplay = 10; // è¡¨ç¤ºã™ã‚‹æœ€å¤§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°

            record.fields.slice(0, maxDisplay).forEach((field, index) => {
                const fieldName = getFieldName(record.recordType, index);
                const isEmpty = !field || field.trim() === '';

                html += `
                    <div class="field-info">
                        <div class="field-label">${index + 1}:</div>
                        <div class="field-value">${fieldName}</div>
                        <div class="field-status">
                            ${isEmpty ? '(ç©ºç™½)' : field.length > 30 ? field.substring(0, 30) + '...' : field}
                        </div>
                    </div>
                `;
            });

            if (record.fields.length > maxDisplay) {
                html += `<div style="text-align: center; color: #718096; margin-top: 10px;">
                    ä»– ${record.fields.length - maxDisplay} ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰...
                </div>`;
            }

            return html;
        }

        function getFieldName(recordType, index) {
            if (recordType.startsWith('VER') && NSIPS_SPEC.headerFields[index]) {
                return NSIPS_SPEC.headerFields[index].name;
            }
            if (recordType === '1' && NSIPS_SPEC.patientFields[index]) {
                return NSIPS_SPEC.patientFields[index].name;
            }
            return `é …ç•ª${index + 1}`;
        }

        function loadSampleData() {
            const sampleData = `VER010603,20250722153322,,PCCLIENT1,14,4,0842302,ãƒ†ã‚¹ãƒˆè–¬å±€,2360042,ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚é‡‘æ²¢åŒºãƒ†ã‚¹ãƒˆç”º1-2-3,0457111111,
1,,ï¾”ï¾ï¾€ï¾ ï¾€ï¾›ï½³,å±±ç”°ã€€å¤ªéƒ,1,19800101,2360045,ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚é‡‘æ²¢åŒºã‚µãƒ³ãƒ—ãƒ«ç”º4-5-6,,,08011112222,,2,2,144105,20230801,ï¼—ï¼,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,
2,990235520035206,41,U,20250722,,,20250722,0,0,0,206,0800052,14,ã‚µãƒ³ãƒ—ãƒ«ç—…é™¢,2360037,æ¨ªæµœå¸‚é‡‘æ²¢åŒºãƒ†ã‚¹ãƒˆæ±1-2-3,0457333333,49,å†…ç§‘,,,794,ï½»ï¾„ï½³ ï½¼ï¾ï¾›ï½³,ä½è—¤ã€€æ¬¡éƒ,0,,,,,,,,,0,0,0,0,0,0,0,0
3,1,*1000,ï¼‘æ—¥ï¼‘å›ã€€æœé£Ÿå¾Œæœç”¨,,,,,2,1,70,0,,1,0,0,,,,,,
4,1,1,1,3969010F2030,621951001,,ï½»ï¾ï¾Œï¾Ÿï¾™50,ã‚µãƒ³ãƒ—ãƒ«éŒ ï¼•ï¼ï½ï½‡,ãƒ†ã‚¹ãƒˆæˆåˆ†éŒ ï¼•ï¼ï½ï½‡,0,0,0,0,0,0,1,1,éŒ ,0,0,0,0,1,82.1,,,,,,,,0,,,,,,,,
5,560,0,0,0,448,0,0,0,0,0,0,560,0,0,0,0,0,0,0,0
6,1,0,8,70,560,0,560,,,,,,,,,,,,,,,,,,,,`;

            document.getElementById('dataInput').value = sampleData;
        }

        function loadEscapeSequenceData() {
            // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å½¢å¼ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
            const escapeData = `VER010603,20250722153322,,PCCLIENT1,14,4,0842302,ãƒ†ã‚¹ãƒˆè–¬å±€,2360042,ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚é‡‘æ²¢åŒºãƒ†ã‚¹ãƒˆç”º1-2-3,0457111111,\\n1,,ï¾”ï¾ï¾€ï¾ ï¾€ï¾›ï½³,å±±ç”°ã€€å¤ªéƒ,1,19800101,2360045,ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚é‡‘æ²¢åŒºã‚µãƒ³ãƒ—ãƒ«ç”º4-5-6,,,08011112222,,2,2,144105,20230801,ï¼—ï¼,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,\\n2,990235520035206,41,U,20250722,,,20250722,0,0,0,206,0800052,14,ã‚µãƒ³ãƒ—ãƒ«ç—…é™¢,2360037,æ¨ªæµœå¸‚é‡‘æ²¢åŒºãƒ†ã‚¹ãƒˆæ±1-2-3,0457333333,49,å†…ç§‘,,,794,ï½»ï¾„ï½³ ï½¼ï¾ï¾›ï½³,ä½è—¤ã€€æ¬¡éƒ,0,,,,,,,,,0,0,0,0,0,0,0,0\\n3,1,*1000,ï¼‘æ—¥ï¼‘å›ã€€æœé£Ÿå¾Œæœç”¨,,,,,2,1,70,0,,1,0,0,,,,,,\\n4,1,1,1,3969010F2030,621951001,,ï½»ï¾ï¾Œï¾Ÿï¾™50,ã‚µãƒ³ãƒ—ãƒ«éŒ ï¼•ï¼ï½ï½‡,ãƒ†ã‚¹ãƒˆæˆåˆ†éŒ ï¼•ï¼ï½ï½‡,0,0,0,0,0,0,1,1,éŒ ,0,0,0,0,1,82.1,,,,,,,,0,,,,,,,,`;

            document.getElementById('dataInput').value = escapeData;
        }

        function clearData() {
            document.getElementById('dataInput').value = '';
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function showError(message) {
            const section = document.getElementById('resultsSection');
            const resultsDiv = document.getElementById('validationResults');

            resultsDiv.innerHTML = `
                <div class="validation-result result-error">
                    <div class="record-header">âŒ ã‚¨ãƒ©ãƒ¼</div>
                    <div>${message}</div>
                </div>
            `;

            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('versionInfo').classList.add('hidden');
            section.classList.remove('hidden');
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function switchTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé¸æŠæ©Ÿèƒ½
        function selectFormat(format) {
            document.querySelectorAll('#formatterTab .format-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`#formatterTab .format-option[onclick="selectFormat('${format}')"]`).classList.add('selected');
            document.querySelector(`input[value="${format}"]`).checked = true;
        }

        // ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼é¸æŠæ©Ÿèƒ½
        function selectConverter(converter) {
            document.querySelectorAll('#converterTab .format-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`#converterTab .format-option[onclick="selectConverter('${converter}')"]`).classList.add('selected');
            document.querySelector(`input[value="${converter}"]`).checked = true;
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ©Ÿèƒ½
        function formatData() {
            const input = document.getElementById('formatterInput').value.trim();
            const selectedFormat = document.querySelector('input[name="format"]:checked').value;

            if (!input) {
                showFormatterError('ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            try {
                let result = '';

                switch (selectedFormat) {
                    case 'json':
                        const parsed = JSON.parse(input);
                        result = JSON.stringify(parsed, null, 2);
                        break;

                    case 'csv':
                        result = formatCSV(input);
                        break;

                    case 'minify':
                        const minified = JSON.parse(input);
                        result = JSON.stringify(minified);
                        break;

                    default:
                        throw new Error('æœªå¯¾å¿œã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã™');
                }

                displayFormatterResult(result, selectedFormat);

            } catch (error) {
                showFormatterError('ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // CSVæ•´å½¢æ©Ÿèƒ½
        function formatCSV(input) {
            const lines = input.split('\n').filter(line => line.trim());
            const formatted = lines.map(line => {
                const fields = line.split(',').map(field => field.trim());
                return fields.join(', ');
            });
            return formatted.join('\n');
        }

        // ãƒ‡ãƒ¼ã‚¿å¤‰æ›æ©Ÿèƒ½
        function convertData() {
            const input = document.getElementById('converterInput').value.trim();
            const selectedConverter = document.querySelector('input[name="converter"]:checked').value;

            if (!input) {
                showConverterError('ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            try {
                let result = '';

                switch (selectedConverter) {
                    case 'json-to-csv':
                        result = jsonToCsv(JSON.parse(input));
                        break;

                    case 'csv-to-json':
                        result = JSON.stringify(csvToJson(input), null, 2);
                        break;

                    case 'nsips-to-json':
                        result = JSON.stringify(nsipsToJson(input), null, 2);
                        break;

                    default:
                        throw new Error('æœªå¯¾å¿œã®å¤‰æ›å½¢å¼ã§ã™');
                }

                displayConverterResult(result, selectedConverter);

            } catch (error) {
                showConverterError('å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // JSON to CSV å¤‰æ›
        function jsonToCsv(jsonData) {
            if (!Array.isArray(jsonData)) {
                throw new Error('CSVã«å¤‰æ›ã™ã‚‹ã«ã¯JSONã®é…åˆ—ãŒå¿…è¦ã§ã™');
            }

            if (jsonData.length === 0) return '';

            const headers = Object.keys(jsonData[0]);
            const csvContent = [
                headers.join(','),
                ...jsonData.map(row =>
                    headers.map(header => {
                        const value = row[header];
                        return typeof value === 'string' && value.includes(',')
                            ? `"${value}"`
                            : value;
                    }).join(',')
                )
            ].join('\n');

            return csvContent;
        }

        // CSV to JSON å¤‰æ›
        function csvToJson(csvData) {
            const lines = csvData.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('CSVã«ã¯æœ€ä½2è¡Œï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼+ãƒ‡ãƒ¼ã‚¿ï¼‰ãŒå¿…è¦ã§ã™');
            }

            const headers = lines[0].split(',').map(h => h.trim());
            const jsonArray = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                jsonArray.push(obj);
            }

            return jsonArray;
        }

        // NSIPS to JSON å¤‰æ›
        function nsipsToJson(nsipsData) {
            const lines = nsipsData.trim().split('\n').filter(line => line.trim());
            const result = {
                header: null,
                patient: null,
                prescriptions: [],
                usages: [],
                medicines: [],
                dispensing: [],
                dispensingDetails: []
            };

            lines.forEach(line => {
                const fields = line.split(',');
                const recordType = fields[0];

                switch (recordType) {
                    case 'VER010603':
                    case 'VER010401':
                        result.header = {
                            version: fields[0],
                            sendDateTime: fields[1],
                            pharmacyCode: fields[6],
                            pharmacyName: fields[7],
                            pharmacyAddress: fields[9]
                        };
                        break;

                    case '1':
                        result.patient = {
                            patientCode: fields[1],
                            patientKanaName: fields[2],
                            patientKanjiName: fields[3],
                            gender: fields[4],
                            birthDate: fields[5],
                            address: fields[7]
                        };
                        break;

                    case '2':
                        result.prescriptions.push({
                            prescriptionNumber: fields[1],
                            receptionNumber: fields[2],
                            updateType: fields[3],
                            prescriptionDate: fields[4],
                            dispensingDate: fields[7],
                            hospitalName: fields[14],
                            doctorName: fields[24]
                        });
                        break;

                    case '3':
                        result.usages.push({
                            rpNumber: fields[1],
                            usageCode: fields[2],
                            usageName: fields[3],
                            rpCategory: fields[8],
                            dayCount: fields[10]
                        });
                        break;

                    case '4':
                        result.medicines.push({
                            medicineNumber: fields[1],
                            rpNumber: fields[2],
                            yjCode: fields[4],
                            medicineName: fields[8],
                            genericName: fields[9],
                            dosage: fields[16],
                            unit: fields[18]
                        });
                        break;
                }
            });

            return result;
        }

        // ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼çµæœè¡¨ç¤º
        function displayFormatterResult(result, format) {
            const section = document.getElementById('formatterResults') || createFormatterResultsSection();

            section.innerHTML = `
                <div class="validation-result result-success">
                    <div class="record-header">
                        âœ… ${format.toUpperCase()}æ•´å½¢å®Œäº†
                    </div>
                    <div class="record-details">
                        <pre style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;">${result}</pre>
                    </div>
                    <div class="button-group" style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="copyToClipboard('${btoa(encodeURIComponent(result))}')">
                            <span>ğŸ“‹</span>çµæœã‚’ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                </div>
            `;

            section.classList.remove('hidden');
        }

        // ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼çµæœè¡¨ç¤º
        function displayConverterResult(result, converter) {
            const section = document.getElementById('converterResults') || createConverterResultsSection();

            section.innerHTML = `
                <div class="validation-result result-success">
                    <div class="record-header">
                        âœ… ${converter}å¤‰æ›å®Œäº†
                    </div>
                    <div class="record-details">
                        <pre style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;">${result}</pre>
                    </div>
                    <div class="button-group" style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="copyToClipboard('${btoa(encodeURIComponent(result))}')">
                            <span>ğŸ“‹</span>çµæœã‚’ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                </div>
            `;

            section.classList.remove('hidden');
        }

        // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ
        function createFormatterResultsSection() {
            const section = document.createElement('div');
            section.id = 'formatterResults';
            section.className = 'results-section';
            document.getElementById('formatterTab').appendChild(section);
            return section;
        }

        function createConverterResultsSection() {
            const section = document.createElement('div');
            section.id = 'converterResults';
            section.className = 'results-section';
            document.getElementById('converterTab').appendChild(section);
            return section;
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyToClipboard(encodedText) {
            const text = decodeURIComponent(atob(encodedText));
            navigator.clipboard.writeText(text).then(() => {
                alert('çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            });
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showFormatterError(message) {
            const section = document.getElementById('formatterResults') || createFormatterResultsSection();
            section.innerHTML = `
                <div class="validation-result result-error">
                    <div class="record-header">âŒ ã‚¨ãƒ©ãƒ¼</div>
                    <div>${message}</div>
                </div>
            `;
            section.classList.remove('hidden');
        }

        function showConverterError(message) {
            const section = document.getElementById('converterResults') || createConverterResultsSection();
            section.innerHTML = `
                <div class="validation-result result-error">
                    <div class="record-header">âŒ ã‚¨ãƒ©ãƒ¼</div>
                    <div>${message}</div>
                </div>
            `;
            section.classList.remove('hidden');
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadFormatterSample() {
            const sampleJson = `{"prescription_number":"20250714112","dispense_date":"2025-07-14","prescriptions":[{"prescription_id":8997223,"institution_name":"ãƒ†ã‚¹ãƒˆç—…é™¢A","doctor_name":"ãƒ†ã‚¹ãƒˆ åŒ»å¸«","department_name":"çš®è†šç§‘","drugs":[{"name":"ãƒ—ãƒ¬ãƒ‰ãƒ‹ã‚¾ãƒ­ãƒ³éŒ ï¼‘ï½ï½‡","dose":1.5,"unit":"éŒ "}]}]}`;
            document.getElementById('formatterInput').value = sampleJson;
        }

        function loadConverterSample() {
            const converter = document.querySelector('input[name="converter"]:checked').value;
            let sample = '';

            switch (converter) {
                case 'json-to-csv':
                    sample = `[{"name":"ãƒ†ã‚¹ãƒˆå¤ªéƒ","age":25,"department":"å†…ç§‘"},{"name":"ã‚µãƒ³ãƒ—ãƒ«èŠ±å­","age":30,"department":"å¤–ç§‘"}]`;
                    break;
                case 'csv-to-json':
                    sample = `name,age,department\nãƒ†ã‚¹ãƒˆå¤ªéƒ,25,å†…ç§‘\nã‚µãƒ³ãƒ—ãƒ«èŠ±å­,30,å¤–ç§‘`;
                    break;
                case 'nsips-to-json':
                    sample = `VER010603,20250722153322,,PCCLIENT1,14,4,0842302,ãƒ†ã‚¹ãƒˆè–¬å±€,2360042,ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚é‡‘æ²¢åŒºãƒ†ã‚¹ãƒˆç”º1-2-3,0457111111,\n1,,ï¾”ï¾ï¾€ï¾ ï¾€ï¾›ï½³,å±±ç”°ã€€å¤ªéƒ,1,19800101,2360045,ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚é‡‘æ²¢åŒºã‚µãƒ³ãƒ—ãƒ«ç”º4-5-6,,,08011112222,,2,2,144105,20230801,ï¼—ï¼,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,`;
                    break;
            }

            document.getElementById('converterInput').value = sample;
        }

        // ã‚¯ãƒªã‚¢æ©Ÿèƒ½
        function clearFormatter() {
            document.getElementById('formatterInput').value = '';
            const section = document.getElementById('formatterResults');
            if (section) section.classList.add('hidden');
        }

        function clearConverter() {
            document.getElementById('converterInput').value = '';
            const section = document.getElementById('converterResults');
            if (section) section.classList.add('hidden');
        }
    </script>
    </body>
    </html>