<div class="main-content">
    <!-- ツールボックスタブナビゲーション -->
    <div class="tab-container">
        <button class="tab active" onclick="switchTab('validator')">
            <div class="tab-icon">🔍</div>
            <div class="tab-title">NSIPSバリデーター</div>
            <div class="tab-subtitle">データ検証ツール</div>
        </button>
        <button class="tab" onclick="switchTab('formatter')">
            <div class="tab-icon">🎨</div>
            <div class="tab-title">データフォーマッター</div>
            <div class="tab-subtitle">JSON/CSV整形ツール</div>
        </button>
        <button class="tab" onclick="switchTab('converter')">
            <div class="tab-icon">🔄</div>
            <div class="tab-title">データ変換器</div>
            <div class="tab-subtitle">形式変換ツール</div>
        </button>
    </div>

    <!-- NSIPSバリデータータブ -->
    <div id="validatorTab" class="tab-content active">
        <div class="tool-section" data-tool="VALIDATOR">
            <h3>🔍 NSIPSデータバリデーション</h3>
            <textarea id="dataInput" placeholder="NSIPSデータをここに貼り付けてください...&#10;&#10;📝 サポートする改行形式:&#10;• Windows形式 (CRLF: \r\n)&#10;• Unix/Linux形式 (LF: \n)&#10;• Classic Mac形式 (CR: \r)&#10;• エスケープシーケンス (\n, \r\n, \r)&#10;&#10;例:&#10;VER010603,20250722153322,,PCCLIENT1,14,4,0842302,テスト薬局,2360042,神奈川県横浜市金沢区テスト町1-2-3,0457111111,&#10;1,,ﾔﾏﾀﾞ ﾀﾛｳ,山田　太郎,1,19800101,2360045,神奈川県横浜市金沢区サンプル町4-5-6,,,08011112222,,2,2,144105,20230801,７０,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,"></textarea>

            <div class="button-group">
                <button class="btn btn-primary" onclick="validateData()">
                    <span>🔍</span>バリデーション実行
                </button>
                <button class="btn btn-secondary" onclick="loadSampleData()">
                    <span>📄</span>サンプルデータ読込
                </button>
                <button class="btn btn-secondary" onclick="loadEscapeSequenceData()">
                    <span>🔤</span>エスケープ形式サンプル
                </button>
                <button class="btn btn-secondary" onclick="clearData()">
                    <span>🗑️</span>クリア
                </button>
            </div>
        </div>
    </div>

    <!-- データフォーマッタータブ -->
    <div id="formatterTab" class="tab-content">
        <div class="tool-section" data-tool="FORMATTER">
            <h3>🎨 データ整形オプション</h3>

            <div class="formatter-controls">
                <div class="format-option selected" onclick="selectFormat('json')">
                    <input type="radio" name="format" value="json" checked>
                    <span>📄 JSON整形</span>
                </div>
                <div class="format-option" onclick="selectFormat('csv')">
                    <input type="radio" name="format" value="csv">
                    <span>📊 CSV整形</span>
                </div>
                <div class="format-option" onclick="selectFormat('minify')">
                    <input type="radio" name="format" value="minify">
                    <span>🗜️ JSON圧縮</span>
                </div>
            </div>

            <textarea id="formatterInput" placeholder="整形したいデータをここに貼り付けてください...&#10;&#10;📝 サポート形式:&#10;• JSON (オブジェクト・配列)&#10;• CSV (カンマ区切り)&#10;• TSV (タブ区切り)&#10;• 改行区切りデータ&#10;&#10;例 (JSON):&#10;{&quot;name&quot;:&quot;テスト&quot;,&quot;value&quot;:123}&#10;&#10;例 (CSV):&#10;name,value&#10;テスト,123"></textarea>

            <div class="button-group">
                <button class="btn btn-primary" onclick="formatData()">
                    <span>🎨</span>データ整形実行
                </button>
                <button class="btn btn-secondary" onclick="loadFormatterSample()">
                    <span>📄</span>サンプル読込
                </button>
                <button class="btn btn-secondary" onclick="clearFormatter()">
                    <span>🗑️</span>クリア
                </button>
            </div>
        </div>
    </div>

    <!-- データ変換器タブ -->
    <div id="converterTab" class="tab-content">
        <div class="tool-section" data-tool="CONVERTER">
            <h3>🔄 データ変換オプション</h3>

            <div class="formatter-controls">
                <div class="format-option selected" onclick="selectConverter('json-to-csv')">
                    <input type="radio" name="converter" value="json-to-csv" checked>
                    <span>📄➡️📊 JSON → CSV</span>
                </div>
                <div class="format-option" onclick="selectConverter('csv-to-json')">
                    <input type="radio" name="converter" value="csv-to-json">
                    <span>📊➡️📄 CSV → JSON</span>
                </div>
                <div class="format-option" onclick="selectConverter('nsips-to-json')">
                    <input type="radio" name="converter" value="nsips-to-json">
                    <span>🏥➡️📄 NSIPS → JSON</span>
                </div>
            </div>

            <textarea id="converterInput" placeholder="変換したいデータをここに貼り付けてください...&#10;&#10;🔄 変換パターン:&#10;• JSON → CSV: JSONオブジェクトをCSV形式に変換&#10;• CSV → JSON: CSV形式をJSONオブジェクトに変換&#10;• NSIPS → JSON: NSIPSデータを構造化JSONに変換&#10;&#10;例 (JSON → CSV):&#10;[{&quot;name&quot;:&quot;テスト&quot;,&quot;age&quot;:25},{&quot;name&quot;:&quot;サンプル&quot;,&quot;age&quot;:30}]"></textarea>

            <div class="button-group">
                <button class="btn btn-primary" onclick="convertData()">
                    <span>🔄</span>データ変換実行
                </button>
                <button class="btn btn-secondary" onclick="loadConverterSample()">
                    <span>📄</span>サンプル読込
                </button>
                <button class="btn btn-secondary" onclick="clearConverter()">
                    <span>🗑️</span>クリア
                </button>
            </div>
        </div>
    </div><!DOCTYPE html>
    <html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>NSIPSデータバリデーター</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            // 初期化
            document.addEventListener('DOMContentLoaded', function() {
                console.log('医療データツールボックス Ver. 1.06.03 対応版が読み込まれました');

            // デフォルトでバリデータータブを表示
            switchTab('validator');
            });

                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    padding: 20px;
                    color: #333;
                }

                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                    overflow: hidden;
                }

                .header {
                    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
                    color: white;
                    padding: 30px;
                    text-align: center;
                }

                .header h1 {
                    font-size: 2.5rem;
                    margin-bottom: 10px;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                }

                .header p {
                    font-size: 1.1rem;
                    opacity: 0.9;
                }

                .main-content {
                    padding: 30px;
                }

                .input-section {
                    background: #f7fafc;
                    border-radius: 15px;
                    padding: 25px;
                    margin-bottom: 30px;
                    border: 2px solid #e2e8f0;
                }

                .input-section h2 {
                    color: #2d3748;
                    margin-bottom: 15px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .input-section h2::before {
                    content: "📝";
                    font-size: 1.5rem;
                }

                textarea {
                    width: 100%;
                    height: 200px;
                    padding: 15px;
                    border: 2px solid #cbd5e0;
                    border-radius: 10px;
                    font-family: 'Courier New', monospace;
                    font-size: 14px;
                    resize: vertical;
                    transition: border-color 0.3s ease;
                }

                textarea:focus {
                    outline: none;
                    border-color: #667eea;
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                }

                .button-group {
                    display: flex;
                    gap: 15px;
                    margin-top: 20px;
                    flex-wrap: wrap;
                }

                .btn {
                    padding: 12px 24px;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }

                .btn-primary {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                }

                .btn-primary:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
                }

                .btn-secondary {
                    background: #f7fafc;
                    color: #4a5568;
                    border: 2px solid #e2e8f0;
                }

                .btn-secondary:hover {
                    background: #edf2f7;
                    border-color: #cbd5e0;
                }

                .results-section {
                    background: #ffffff;
                    border-radius: 15px;
                    padding: 25px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                    border: 1px solid #e2e8f0;
                }

                .results-section h2 {
                    color: #2d3748;
                    margin-bottom: 20px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .validation-result {
                    margin-bottom: 20px;
                    padding: 15px;
                    border-radius: 10px;
                    border-left: 4px solid;
                }

                .result-success {
                    background: #f0fff4;
                    border-color: #38a169;
                    color: #2f855a;
                }

                .result-warning {
                    background: #fffbeb;
                    border-color: #ed8936;
                    color: #c05621;
                }

                .result-error {
                    background: #fed7d7;
                    border-color: #e53e3e;
                    color: #c53030;
                }

                .record-details {
                    background: #f7fafc;
                    border-radius: 8px;
                    padding: 15px;
                    margin-top: 15px;
                    font-family: 'Courier New', monospace;
                    font-size: 12px;
                    max-height: 300px;
                    overflow-y: auto;
                }

                .record-header {
                    font-weight: bold;
                    color: #2d3748;
                    margin-bottom: 10px;
                    padding-bottom: 5px;
                    border-bottom: 1px solid #cbd5e0;
                }

                .field-info {
                    display: grid;
                    grid-template-columns: 100px 200px 1fr;
                    gap: 10px;
                    margin-bottom: 8px;
                    padding: 5px;
                    background: white;
                    border-radius: 4px;
                }

                .field-label {
                    font-weight: bold;
                    color: #4a5568;
                }

                .field-value {
                    color: #2d3748;
                    word-break: break-all;
                }

                .field-status {
                    color: #718096;
                    font-style: italic;
                }

                .stats {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }

                .stat-card {
                    background: white;
                    padding: 20px;
                    border-radius: 12px;
                    text-align: center;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                    border: 1px solid #e2e8f0;
                }

                .stat-number {
                    font-size: 2rem;
                    font-weight: bold;
                    color: #667eea;
                    display: block;
                }

                .stat-label {
                    color: #718096;
                    margin-top: 5px;
                }

                .version-info {
                    background: #ebf8ff;
                    border: 1px solid #bee3f8;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 20px;
                }

                .tab-container {
                    display: flex;
                    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
                    border-radius: 15px;
                    padding: 8px;
                    margin-bottom: 20px;
                    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
                    gap: 8px;
                    flex-wrap: wrap;
                }

                .tab {
                    flex: 1;
                    min-width: 200px;
                    padding: 16px 20px;
                    background: white;
                    border: 2px solid transparent;
                    border-radius: 12px;
                    cursor: pointer;
                    font-weight: 600;
                    transition: all 0.4s ease;
                    color: #4a5568;
                    text-align: center;
                    position: relative;
                    overflow: hidden;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                }

                .tab::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
                    transition: left 0.5s ease;
                }

                .tab:hover::before {
                    left: 100%;
                }

                .tab.active {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border-color: #5a67d8;
                    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
                    transform: translateY(-2px);
                }

                .tab:hover:not(.active) {
                    background: #f1f5f9;
                    border-color: #cbd5e0;
                    transform: translateY(-1px);
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                }

                .tab-icon {
                    font-size: 1.5rem;
                    display: block;
                    margin-bottom: 8px;
                }

                .tab-title {
                    font-size: 0.95rem;
                    font-weight: 700;
                }

                .tab-subtitle {
                    font-size: 0.75rem;
                    opacity: 0.8;
                    margin-top: 4px;
                }

                .tab-content {
                    display: none;
                    background: white;
                    border-radius: 20px;
                    padding: 30px;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
                    border: 1px solid #e2e8f0;
                    position: relative;
                    overflow: hidden;
                }

                .tab-content::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    height: 4px;
                    background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
                }

                .tab-content.active {
                    display: block;
                    animation: fadeInUp 0.5s ease;
                }

                @keyframes fadeInUp {
                    from {
                        opacity: 0;
                        transform: translateY(20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                .tool-section {
                    background: #f8fafc;
                    border-radius: 15px;
                    padding: 25px;
                    margin-bottom: 25px;
                    border-left: 4px solid #667eea;
                    position: relative;
                }

                .tool-section::before {
                    content: attr(data-tool);
                    position: absolute;
                    top: -12px;
                    left: 20px;
                    background: #667eea;
                    color: white;
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 0.8rem;
                    font-weight: 600;
                }

                .tool-section h3 {
                    color: #2d3748;
                    margin-bottom: 15px;
                    margin-top: 10px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .format-option {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    padding: 12px 16px;
                    background: white;
                    border: 2px solid #e2e8f0;
                    border-radius: 12px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;
                }

                .format-option::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
                    transition: left 0.4s ease;
                }

                .format-option:hover::before {
                    left: 100%;
                }

                .format-option:hover {
                    border-color: #667eea;
                    transform: translateY(-1px);
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
                }

                .format-option.selected {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border-color: #5a67d8;
                    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
                }

                .format-option input[type="radio"] {
                    margin: 0;
                    transform: scale(1.2);
                }

                .formatter-controls {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                    margin-bottom: 25px;
                }

                .hidden {
                    display: none;
                }
                .container {
                    margin: 10px;
                    border-radius: 15px;
                }

                .main-content {
                    padding: 20px;
                }

                .button-group {
                    flex-direction: column;
                }

                .field-info {
                    grid-template-columns: 1fr;
                    gap: 5px;
                }
            }
        </style>
    </head>
    <body>
    <div class="container">
        <div class="header">
            <h1>🧰 医療データツールボックス</h1>
            <p>NSIPS バリデーター & データフォーマッター - 新調剤システム標準IF対応</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2>NSIPSデータ入力</h2>
                <textarea id="dataInput" placeholder="NSIPSデータをここに貼り付けてください...&#10;&#10;📝 サポートする改行形式:&#10;• Windows形式 (CRLF: \r\n)&#10;• Unix/Linux形式 (LF: \n)&#10;• Classic Mac形式 (CR: \r)&#10;• エスケープシーケンス (\n, \r\n, \r)&#10;&#10;例:&#10;VER010603,20250722153322,,PCCLIENT1,14,4,0842302,テスト薬局,2360042,神奈川県横浜市金沢区テスト町1-2-3,0457111111,&#10;1,,ﾔﾏﾀﾞ ﾀﾛｳ,山田　太郎,1,19800101,2360045,神奈川県横浜市金沢区サンプル町4-5-6,,,08011112222,,2,2,144105,20230801,７０,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,"></textarea>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="validateData()">
                        <span>🔍</span>バリデーション実行
                    </button>
                    <button class="btn btn-secondary" onclick="loadSampleData()">
                        <span>📄</span>サンプルデータ読込
                    </button>
                    <button class="btn btn-secondary" onclick="loadEscapeSequenceData()">
                        <span>🔤</span>エスケープ形式サンプル
                    </button>
                    <button class="btn btn-secondary" onclick="clearData()">
                        <span>🗑️</span>クリア
                    </button>
                </div>
            </div>

            <div id="resultsSection" class="results-section hidden">
                <h2><span id="resultsIcon">📊</span>バリデーション結果</h2>

                <div id="versionInfo" class="version-info hidden">
                    <strong>バージョン情報:</strong> <span id="versionText"></span>
                </div>

                <div id="statsSection" class="stats hidden">
                    <div class="stat-card">
                        <span class="stat-number" id="totalRecords">0</span>
                        <div class="stat-label">総レコード数</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="validRecords">0</span>
                        <div class="stat-label">有効レコード</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="warningRecords">0</span>
                        <div class="stat-label">警告</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="errorRecords">0</span>
                        <div class="stat-label">エラー</div>
                    </div>
                </div>

                <div id="validationResults"></div>
            </div>
        </div>
    </div>

    <script>
        // NSIPS仕様定義
        const NSIPS_SPEC = {
            version: "1.06.03",
            expectedVersion: "VER010603",

            recordTypes: {
                'HEADER': { id: 'VER', name: 'ヘッダ部', required: true },
                '1': { id: '1', name: '患者情報部', required: true },
                '2': { id: '2', name: '処方箋情報部', required: true },
                '3': { id: '3', name: '用法部', required: true },
                '4': { id: '4', name: '薬品部', required: true },
                '5': { id: '5', name: '調剤録部', required: false },
                '6': { id: '6', name: '調剤録明細部', required: false },
                '7': { id: '7', name: '基本料・薬学管理料情報部', required: false },
                '8': { id: '8', name: 'お薬手帳情報部', required: false }
            },

            headerFields: [
                { name: "バージョン情報", required: true, pattern: /^VER\d{6}$/ },
                { name: "送信日時", required: true, pattern: /^\d{14}$/ },
                { name: "備考", required: false },
                { name: "送信端末識別情報", required: false },
                { name: "都道府県番号", required: true, pattern: /^\d{2}$/ },
                { name: "点数表", required: true, pattern: /^4$/ },
                { name: "薬局コード", required: true, pattern: /^\d{7}$/ },
                { name: "薬局名", required: true },
                { name: "薬局郵便番号", required: true, pattern: /^\d{7}$/ },
                { name: "薬局所在地", required: true },
                { name: "薬局電話番号", required: true, pattern: /^\d+$/ },
                { name: "旧ファイル名", required: false }
            ],

            patientFields: [
                { name: "識別子", required: true, pattern: /^1$/ },
                { name: "患者コード", required: true },
                { name: "患者カナ氏名", required: true },
                { name: "患者漢字氏名", required: true },
                { name: "性別", required: true, pattern: /^[012]$/ },
                { name: "生年月日", required: true, pattern: /^\d{8}$/ }
            ]
        };

        function validateData() {
            const input = document.getElementById('dataInput').value.trim();

            if (!input) {
                showError('データが入力されていません。');
                return;
            }

            try {
                const processedData = normalizeLineBreaks(input);
                const lines = processedData.lines.filter(line => line.trim());
                const results = performValidation(lines);
                results.lineBreakInfo = processedData.info;
                displayResults(results);
            } catch (error) {
                showError('バリデーション中にエラーが発生しました: ' + error.message);
            }
        }

        function normalizeLineBreaks(input) {
            // 改行コードの検出と正規化
            const detectionInfo = {
                originalFormat: 'unknown',
                hasEscapeSequences: false,
                detectedPatterns: [],
                processedInput: input
            };

            // エスケープシーケンスの検出
            const escapePatterns = [
                { pattern: /\\r\\n/g, type: 'CRLF escape (\\r\\n)', replacement: '\r\n' },
                { pattern: /\\n/g, type: 'LF escape (\\n)', replacement: '\n' },
                { pattern: /\\r/g, type: 'CR escape (\\r)', replacement: '\r' }
            ];

            let processedInput = input;

            // エスケープシーケンスの検出と変換
            escapePatterns.forEach(({ pattern, type, replacement }) => {
                const matches = input.match(pattern);
                if (matches) {
                    detectionInfo.hasEscapeSequences = true;
                    detectionInfo.detectedPatterns.push({
                        type: type,
                        count: matches.length
                    });
                    processedInput = processedInput.replace(pattern, replacement);
                }
            });

            // 実際の改行コードの検出
            const lineBreakPatterns = [
                { pattern: /\r\n/g, type: 'CRLF (Windows)', name: 'crlf' },
                { pattern: /\n/g, type: 'LF (Unix/Linux)', name: 'lf' },
                { pattern: /\r/g, type: 'CR (Classic Mac)', name: 'cr' }
            ];

            let detectedLineBreak = null;
            for (const { pattern, type, name } of lineBreakPatterns) {
                const matches = processedInput.match(pattern);
                if (matches && matches.length > 0) {
                    if (!detectedLineBreak || matches.length > detectedLineBreak.count) {
                        detectedLineBreak = {
                            type: type,
                            name: name,
                            count: matches.length
                        };
                    }
                }
            }

            if (detectedLineBreak) {
                detectionInfo.originalFormat = detectedLineBreak.type;
                detectionInfo.detectedPatterns.push({
                    type: detectedLineBreak.type,
                    count: detectedLineBreak.count
                });
            }

            // 正規化（すべてLFに統一）
            const normalizedInput = processedInput.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

            return {
                lines: normalizedInput.split('\n'),
                info: detectionInfo
            };
        }

        function performValidation(lines) {
            const results = {
                total: lines.length,
                valid: 0,
                warnings: 0,
                errors: 0,
                records: [],
                version: null
            };

            lines.forEach((line, index) => {
                const fields = line.split(',');
                const recordType = fields[0];

                const recordResult = {
                    lineNumber: index + 1,
                    recordType: recordType,
                    typeName: getRecordTypeName(recordType),
                    fieldCount: fields.length,
                    status: 'valid',
                    issues: [],
                    fields: fields
                };

                // バージョン情報の抽出
                if (index === 0) {
                    results.version = recordType;
                    validateVersion(recordType, recordResult);
                }

                // レコードタイプ別バリデーション
                validateRecord(recordType, fields, recordResult);

                // 結果の集計
                if (recordResult.status === 'error') {
                    results.errors++;
                } else if (recordResult.status === 'warning') {
                    results.warnings++;
                } else {
                    results.valid++;
                }

                results.records.push(recordResult);
            });

            return results;
        }

        function validateVersion(version, recordResult) {
            if (version !== NSIPS_SPEC.expectedVersion) {
                recordResult.issues.push({
                    type: 'warning',
                    message: `バージョン不一致: ${version} (期待値: ${NSIPS_SPEC.expectedVersion})`
                });
                recordResult.status = 'warning';
            }
        }

        function validateRecord(recordType, fields, recordResult) {
            if (recordType.startsWith('VER')) {
                validateHeaderRecord(fields, recordResult);
            } else if (recordType === '1') {
                validatePatientRecord(fields, recordResult);
            } else if (recordType === '2') {
                validatePrescriptionRecord(fields, recordResult);
            } else if (recordType === '3') {
                validateUsageRecord(fields, recordResult);
            } else if (recordType === '4') {
                validateMedicineRecord(fields, recordResult);
            } else if (['5', '6', '7', '8'].includes(recordType)) {
                validateOptionalRecord(recordType, fields, recordResult);
            } else {
                recordResult.issues.push({
                    type: 'error',
                    message: '不明なレコードタイプです'
                });
                recordResult.status = 'error';
            }
        }

        function validateHeaderRecord(fields, recordResult) {
            NSIPS_SPEC.headerFields.forEach((spec, index) => {
                if (index >= fields.length) {
                    if (spec.required) {
                        recordResult.issues.push({
                            type: 'error',
                            message: `必須項目が不足: ${spec.name}`
                        });
                        recordResult.status = 'error';
                    }
                    return;
                }

                const value = fields[index];
                if (spec.required && (!value || value.trim() === '')) {
                    recordResult.issues.push({
                        type: 'error',
                        message: `必須項目が空白: ${spec.name}`
                    });
                    recordResult.status = 'error';
                }

                if (spec.pattern && value && !spec.pattern.test(value)) {
                    recordResult.issues.push({
                        type: 'warning',
                        message: `フォーマット不正: ${spec.name} (${value})`
                    });
                    if (recordResult.status === 'valid') {
                        recordResult.status = 'warning';
                    }
                }
            });
        }

        function validatePatientRecord(fields, recordResult) {
            if (fields.length < 6) {
                recordResult.issues.push({
                    type: 'error',
                    message: '必須項目が不足しています'
                });
                recordResult.status = 'error';
                return;
            }

            // 性別チェック
            if (fields[4] && !['0', '1', '2'].includes(fields[4])) {
                recordResult.issues.push({
                    type: 'warning',
                    message: `性別コードが不正: ${fields[4]}`
                });
                if (recordResult.status === 'valid') {
                    recordResult.status = 'warning';
                }
            }

            // 生年月日チェック
            if (fields[5] && !/^\d{8}$/.test(fields[5])) {
                recordResult.issues.push({
                    type: 'warning',
                    message: `生年月日フォーマット不正: ${fields[5]}`
                });
                if (recordResult.status === 'valid') {
                    recordResult.status = 'warning';
                }
            }
        }

        function validatePrescriptionRecord(fields, recordResult) {
            if (fields.length < 15) {
                recordResult.issues.push({
                    type: 'error',
                    message: '必須項目が不足しています'
                });
                recordResult.status = 'error';
            }
        }

        function validateUsageRecord(fields, recordResult) {
            if (fields.length < 12) {
                recordResult.issues.push({
                    type: 'error',
                    message: '必須項目が不足しています'
                });
                recordResult.status = 'error';
            }
        }

        function validateMedicineRecord(fields, recordResult) {
            if (fields.length < 19) {
                recordResult.issues.push({
                    type: 'error',
                    message: '必須項目が不足しています'
                });
                recordResult.status = 'error';
            }
        }

        function validateOptionalRecord(recordType, fields, recordResult) {
            recordResult.issues.push({
                type: 'info',
                message: '省略可項目として正常に処理されました'
            });
        }

        function getRecordTypeName(recordType) {
            if (recordType.startsWith('VER')) {
                return 'ヘッダ部';
            }
            const spec = NSIPS_SPEC.recordTypes[recordType];
            return spec ? spec.name : '不明';
        }

        function displayResults(results) {
            const section = document.getElementById('resultsSection');
            const versionInfo = document.getElementById('versionInfo');
            const versionText = document.getElementById('versionText');
            const statsSection = document.getElementById('statsSection');
            const resultsDiv = document.getElementById('validationResults');

            // 統計情報の更新
            document.getElementById('totalRecords').textContent = results.total;
            document.getElementById('validRecords').textContent = results.valid;
            document.getElementById('warningRecords').textContent = results.warnings;
            document.getElementById('errorRecords').textContent = results.errors;

            // バージョン情報の表示
            if (results.version) {
                versionText.textContent = results.version;
                versionInfo.classList.remove('hidden');
            }

            // 改行コード情報の表示
            let html = '';
            if (results.lineBreakInfo) {
                html += generateLineBreakInfo(results.lineBreakInfo);
            }

            // 結果の表示
            results.records.forEach(record => {
                const statusClass = `result-${record.status}`;
                const icon = record.status === 'valid' ? '✅' :
                    record.status === 'warning' ? '⚠️' : '❌';

                html += `
                    <div class="validation-result ${statusClass}">
                        <div class="record-header">
                            ${icon} 行 ${record.lineNumber}: ${record.typeName} (識別子: ${record.recordType})
                        </div>

                        ${record.issues.length > 0 ? `
                            <div style="margin: 10px 0;">
                                ${record.issues.map(issue => `
                                    <div style="margin: 5px 0;">• ${issue.message}</div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <div class="record-details">
                            <div style="margin-bottom: 10px;">
                                <strong>フィールド数:</strong> ${record.fieldCount}
                            </div>
                            ${generateFieldDetails(record)}
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
            statsSection.classList.remove('hidden');
            section.classList.remove('hidden');

            // アイコンの更新
            const icon = results.errors > 0 ? '❌' :
                results.warnings > 0 ? '⚠️' : '✅';
            document.getElementById('resultsIcon').textContent = icon;
        }

        function generateLineBreakInfo(lineBreakInfo) {
            if (!lineBreakInfo.detectedPatterns.length && !lineBreakInfo.hasEscapeSequences) {
                return '';
            }

            let html = `
                <div class="validation-result" style="background: #f0f9ff; border-color: #0284c7; color: #0c4a6e;">
                    <div class="record-header">
                        📝 改行コード検出結果
                    </div>
                    <div style="margin: 10px 0;">
            `;

            if (lineBreakInfo.hasEscapeSequences) {
                html += `<div style="margin: 5px 0;">
                    <strong>エスケープシーケンス検出:</strong> データ内にエスケープ文字列が含まれていました
                </div>`;
            }

            if (lineBreakInfo.originalFormat !== 'unknown') {
                html += `<div style="margin: 5px 0;">
                    <strong>検出された改行形式:</strong> ${lineBreakInfo.originalFormat}
                </div>`;
            }

            if (lineBreakInfo.detectedPatterns.length > 0) {
                html += `<div style="margin: 5px 0;">
                    <strong>詳細パターン:</strong>
                    <ul style="margin: 5px 0 0 20px;">`;

                lineBreakInfo.detectedPatterns.forEach(pattern => {
                    html += `<li>${pattern.type}: ${pattern.count}箇所</li>`;
                });

                html += `</ul></div>`;
            }

            html += `<div style="margin: 5px 0; font-style: italic; color: #0369a1;">
                自動的に標準形式（LF）に正規化して処理しました
            </div></div></div>`;

            return html;
        }

        function generateFieldDetails(record) {
            let html = '';
            const maxDisplay = 10; // 表示する最大フィールド数

            record.fields.slice(0, maxDisplay).forEach((field, index) => {
                const fieldName = getFieldName(record.recordType, index);
                const isEmpty = !field || field.trim() === '';

                html += `
                    <div class="field-info">
                        <div class="field-label">${index + 1}:</div>
                        <div class="field-value">${fieldName}</div>
                        <div class="field-status">
                            ${isEmpty ? '(空白)' : field.length > 30 ? field.substring(0, 30) + '...' : field}
                        </div>
                    </div>
                `;
            });

            if (record.fields.length > maxDisplay) {
                html += `<div style="text-align: center; color: #718096; margin-top: 10px;">
                    他 ${record.fields.length - maxDisplay} フィールド...
                </div>`;
            }

            return html;
        }

        function getFieldName(recordType, index) {
            if (recordType.startsWith('VER') && NSIPS_SPEC.headerFields[index]) {
                return NSIPS_SPEC.headerFields[index].name;
            }
            if (recordType === '1' && NSIPS_SPEC.patientFields[index]) {
                return NSIPS_SPEC.patientFields[index].name;
            }
            return `項番${index + 1}`;
        }

        function loadSampleData() {
            const sampleData = `VER010603,20250722153322,,PCCLIENT1,14,4,0842302,テスト薬局,2360042,神奈川県横浜市金沢区テスト町1-2-3,0457111111,
1,,ﾔﾏﾀﾞ ﾀﾛｳ,山田　太郎,1,19800101,2360045,神奈川県横浜市金沢区サンプル町4-5-6,,,08011112222,,2,2,144105,20230801,７０,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,
2,990235520035206,41,U,20250722,,,20250722,0,0,0,206,0800052,14,サンプル病院,2360037,横浜市金沢区テスト東1-2-3,0457333333,49,内科,,,794,ｻﾄｳ ｼﾞﾛｳ,佐藤　次郎,0,,,,,,,,,0,0,0,0,0,0,0,0
3,1,*1000,１日１回　朝食後服用,,,,,2,1,70,0,,1,0,0,,,,,,
4,1,1,1,3969010F2030,621951001,,ｻﾝﾌﾟﾙ50,サンプル錠５０ｍｇ,テスト成分錠５０ｍｇ,0,0,0,0,0,0,1,1,錠,0,0,0,0,1,82.1,,,,,,,,0,,,,,,,,
5,560,0,0,0,448,0,0,0,0,0,0,560,0,0,0,0,0,0,0,0
6,1,0,8,70,560,0,560,,,,,,,,,,,,,,,,,,,,`;

            document.getElementById('dataInput').value = sampleData;
        }

        function loadEscapeSequenceData() {
            // エスケープシーケンス形式のサンプルデータ
            const escapeData = `VER010603,20250722153322,,PCCLIENT1,14,4,0842302,テスト薬局,2360042,神奈川県横浜市金沢区テスト町1-2-3,0457111111,\\n1,,ﾔﾏﾀﾞ ﾀﾛｳ,山田　太郎,1,19800101,2360045,神奈川県横浜市金沢区サンプル町4-5-6,,,08011112222,,2,2,144105,20230801,７０,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,\\n2,990235520035206,41,U,20250722,,,20250722,0,0,0,206,0800052,14,サンプル病院,2360037,横浜市金沢区テスト東1-2-3,0457333333,49,内科,,,794,ｻﾄｳ ｼﾞﾛｳ,佐藤　次郎,0,,,,,,,,,0,0,0,0,0,0,0,0\\n3,1,*1000,１日１回　朝食後服用,,,,,2,1,70,0,,1,0,0,,,,,,\\n4,1,1,1,3969010F2030,621951001,,ｻﾝﾌﾟﾙ50,サンプル錠５０ｍｇ,テスト成分錠５０ｍｇ,0,0,0,0,0,0,1,1,錠,0,0,0,0,1,82.1,,,,,,,,0,,,,,,,,`;

            document.getElementById('dataInput').value = escapeData;
        }

        function clearData() {
            document.getElementById('dataInput').value = '';
            document.getElementById('resultsSection').classList.add('hidden');
        }

        function showError(message) {
            const section = document.getElementById('resultsSection');
            const resultsDiv = document.getElementById('validationResults');

            resultsDiv.innerHTML = `
                <div class="validation-result result-error">
                    <div class="record-header">❌ エラー</div>
                    <div>${message}</div>
                </div>
            `;

            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('versionInfo').classList.add('hidden');
            section.classList.remove('hidden');
        }

        // タブ切り替え機能
        function switchTab(tabName) {
            // すべてのタブとコンテンツを非アクティブにする
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // 選択されたタブとコンテンツをアクティブにする
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // フォーマット選択機能
        function selectFormat(format) {
            document.querySelectorAll('#formatterTab .format-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`#formatterTab .format-option[onclick="selectFormat('${format}')"]`).classList.add('selected');
            document.querySelector(`input[value="${format}"]`).checked = true;
        }

        // コンバーター選択機能
        function selectConverter(converter) {
            document.querySelectorAll('#converterTab .format-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`#converterTab .format-option[onclick="selectConverter('${converter}')"]`).classList.add('selected');
            document.querySelector(`input[value="${converter}"]`).checked = true;
        }

        // データフォーマット機能
        function formatData() {
            const input = document.getElementById('formatterInput').value.trim();
            const selectedFormat = document.querySelector('input[name="format"]:checked').value;

            if (!input) {
                showFormatterError('データが入力されていません。');
                return;
            }

            try {
                let result = '';

                switch (selectedFormat) {
                    case 'json':
                        const parsed = JSON.parse(input);
                        result = JSON.stringify(parsed, null, 2);
                        break;

                    case 'csv':
                        result = formatCSV(input);
                        break;

                    case 'minify':
                        const minified = JSON.parse(input);
                        result = JSON.stringify(minified);
                        break;

                    default:
                        throw new Error('未対応のフォーマットです');
                }

                displayFormatterResult(result, selectedFormat);

            } catch (error) {
                showFormatterError('フォーマット中にエラーが発生しました: ' + error.message);
            }
        }

        // CSV整形機能
        function formatCSV(input) {
            const lines = input.split('\n').filter(line => line.trim());
            const formatted = lines.map(line => {
                const fields = line.split(',').map(field => field.trim());
                return fields.join(', ');
            });
            return formatted.join('\n');
        }

        // データ変換機能
        function convertData() {
            const input = document.getElementById('converterInput').value.trim();
            const selectedConverter = document.querySelector('input[name="converter"]:checked').value;

            if (!input) {
                showConverterError('データが入力されていません。');
                return;
            }

            try {
                let result = '';

                switch (selectedConverter) {
                    case 'json-to-csv':
                        result = jsonToCsv(JSON.parse(input));
                        break;

                    case 'csv-to-json':
                        result = JSON.stringify(csvToJson(input), null, 2);
                        break;

                    case 'nsips-to-json':
                        result = JSON.stringify(nsipsToJson(input), null, 2);
                        break;

                    default:
                        throw new Error('未対応の変換形式です');
                }

                displayConverterResult(result, selectedConverter);

            } catch (error) {
                showConverterError('変換中にエラーが発生しました: ' + error.message);
            }
        }

        // JSON to CSV 変換
        function jsonToCsv(jsonData) {
            if (!Array.isArray(jsonData)) {
                throw new Error('CSVに変換するにはJSONの配列が必要です');
            }

            if (jsonData.length === 0) return '';

            const headers = Object.keys(jsonData[0]);
            const csvContent = [
                headers.join(','),
                ...jsonData.map(row =>
                    headers.map(header => {
                        const value = row[header];
                        return typeof value === 'string' && value.includes(',')
                            ? `"${value}"`
                            : value;
                    }).join(',')
                )
            ].join('\n');

            return csvContent;
        }

        // CSV to JSON 変換
        function csvToJson(csvData) {
            const lines = csvData.trim().split('\n');
            if (lines.length < 2) {
                throw new Error('CSVには最低2行（ヘッダー+データ）が必要です');
            }

            const headers = lines[0].split(',').map(h => h.trim());
            const jsonArray = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                jsonArray.push(obj);
            }

            return jsonArray;
        }

        // NSIPS to JSON 変換
        function nsipsToJson(nsipsData) {
            const lines = nsipsData.trim().split('\n').filter(line => line.trim());
            const result = {
                header: null,
                patient: null,
                prescriptions: [],
                usages: [],
                medicines: [],
                dispensing: [],
                dispensingDetails: []
            };

            lines.forEach(line => {
                const fields = line.split(',');
                const recordType = fields[0];

                switch (recordType) {
                    case 'VER010603':
                    case 'VER010401':
                        result.header = {
                            version: fields[0],
                            sendDateTime: fields[1],
                            pharmacyCode: fields[6],
                            pharmacyName: fields[7],
                            pharmacyAddress: fields[9]
                        };
                        break;

                    case '1':
                        result.patient = {
                            patientCode: fields[1],
                            patientKanaName: fields[2],
                            patientKanjiName: fields[3],
                            gender: fields[4],
                            birthDate: fields[5],
                            address: fields[7]
                        };
                        break;

                    case '2':
                        result.prescriptions.push({
                            prescriptionNumber: fields[1],
                            receptionNumber: fields[2],
                            updateType: fields[3],
                            prescriptionDate: fields[4],
                            dispensingDate: fields[7],
                            hospitalName: fields[14],
                            doctorName: fields[24]
                        });
                        break;

                    case '3':
                        result.usages.push({
                            rpNumber: fields[1],
                            usageCode: fields[2],
                            usageName: fields[3],
                            rpCategory: fields[8],
                            dayCount: fields[10]
                        });
                        break;

                    case '4':
                        result.medicines.push({
                            medicineNumber: fields[1],
                            rpNumber: fields[2],
                            yjCode: fields[4],
                            medicineName: fields[8],
                            genericName: fields[9],
                            dosage: fields[16],
                            unit: fields[18]
                        });
                        break;
                }
            });

            return result;
        }

        // フォーマッター結果表示
        function displayFormatterResult(result, format) {
            const section = document.getElementById('formatterResults') || createFormatterResultsSection();

            section.innerHTML = `
                <div class="validation-result result-success">
                    <div class="record-header">
                        ✅ ${format.toUpperCase()}整形完了
                    </div>
                    <div class="record-details">
                        <pre style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;">${result}</pre>
                    </div>
                    <div class="button-group" style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="copyToClipboard('${btoa(encodeURIComponent(result))}')">
                            <span>📋</span>結果をコピー
                        </button>
                    </div>
                </div>
            `;

            section.classList.remove('hidden');
        }

        // コンバーター結果表示
        function displayConverterResult(result, converter) {
            const section = document.getElementById('converterResults') || createConverterResultsSection();

            section.innerHTML = `
                <div class="validation-result result-success">
                    <div class="record-header">
                        ✅ ${converter}変換完了
                    </div>
                    <div class="record-details">
                        <pre style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;">${result}</pre>
                    </div>
                    <div class="button-group" style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="copyToClipboard('${btoa(encodeURIComponent(result))}')">
                            <span>📋</span>結果をコピー
                        </button>
                    </div>
                </div>
            `;

            section.classList.remove('hidden');
        }

        // 結果セクション作成
        function createFormatterResultsSection() {
            const section = document.createElement('div');
            section.id = 'formatterResults';
            section.className = 'results-section';
            document.getElementById('formatterTab').appendChild(section);
            return section;
        }

        function createConverterResultsSection() {
            const section = document.createElement('div');
            section.id = 'converterResults';
            section.className = 'results-section';
            document.getElementById('converterTab').appendChild(section);
            return section;
        }

        // クリップボードにコピー
        function copyToClipboard(encodedText) {
            const text = decodeURIComponent(atob(encodedText));
            navigator.clipboard.writeText(text).then(() => {
                alert('結果をクリップボードにコピーしました！');
            });
        }

        // エラー表示
        function showFormatterError(message) {
            const section = document.getElementById('formatterResults') || createFormatterResultsSection();
            section.innerHTML = `
                <div class="validation-result result-error">
                    <div class="record-header">❌ エラー</div>
                    <div>${message}</div>
                </div>
            `;
            section.classList.remove('hidden');
        }

        function showConverterError(message) {
            const section = document.getElementById('converterResults') || createConverterResultsSection();
            section.innerHTML = `
                <div class="validation-result result-error">
                    <div class="record-header">❌ エラー</div>
                    <div>${message}</div>
                </div>
            `;
            section.classList.remove('hidden');
        }

        // サンプルデータ読み込み
        function loadFormatterSample() {
            const sampleJson = `{"prescription_number":"20250714112","dispense_date":"2025-07-14","prescriptions":[{"prescription_id":8997223,"institution_name":"テスト病院A","doctor_name":"テスト 医師","department_name":"皮膚科","drugs":[{"name":"プレドニゾロン錠１ｍｇ","dose":1.5,"unit":"錠"}]}]}`;
            document.getElementById('formatterInput').value = sampleJson;
        }

        function loadConverterSample() {
            const converter = document.querySelector('input[name="converter"]:checked').value;
            let sample = '';

            switch (converter) {
                case 'json-to-csv':
                    sample = `[{"name":"テスト太郎","age":25,"department":"内科"},{"name":"サンプル花子","age":30,"department":"外科"}]`;
                    break;
                case 'csv-to-json':
                    sample = `name,age,department\nテスト太郎,25,内科\nサンプル花子,30,外科`;
                    break;
                case 'nsips-to-json':
                    sample = `VER010603,20250722153322,,PCCLIENT1,14,4,0842302,テスト薬局,2360042,神奈川県横浜市金沢区テスト町1-2-3,0457111111,\n1,,ﾔﾏﾀﾞ ﾀﾛｳ,山田　太郎,1,19800101,2360045,神奈川県横浜市金沢区サンプル町4-5-6,,,08011112222,,2,2,144105,20230801,７０,12345678,1,20,80,0,,,,,,,,,,,,,,,,0,0,0,0,0,0,0,0,0,0,0,`;
                    break;
            }

            document.getElementById('converterInput').value = sample;
        }

        // クリア機能
        function clearFormatter() {
            document.getElementById('formatterInput').value = '';
            const section = document.getElementById('formatterResults');
            if (section) section.classList.add('hidden');
        }

        function clearConverter() {
            document.getElementById('converterInput').value = '';
            const section = document.getElementById('converterResults');
            if (section) section.classList.add('hidden');
        }
    </script>
    </body>
    </html>